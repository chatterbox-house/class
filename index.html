<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterbox English Learning</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #7209b7;
            --text: #2b2d42;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }
        
body {
    background-color: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    width: 100vw;
    padding: 20px;
    font-size: 24px;
    background-image: radial-gradient(circle at 10% 20%, rgba(67, 97, 238, 0.1) 0%, rgba(72, 149, 239, 0.1) 90%);
    overflow: hidden;
    position: fixed;
    margin: 0;
}
        
.container {
    width: 95%;
    max-width: 1200px;
    text-align: center;
    background-color: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    padding: 30px;
    position: relative;
    overflow: hidden;
    max-height: 95vh;
}
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--warning));
        }
        
        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon {
            margin-right: 15px;
            font-size: 3rem;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 2.8rem;
            font-weight: 700;
            position: relative;
            display: inline-block;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 5px;
            background: var(--accent);
            border-radius: 3px;
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 25px 40px;
            font-size: 1.8rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 300px;
            min-height: 100px;
            margin: 15px;
            box-shadow: 0 6px 10px rgba(0,0,0,0.1);
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover, .btn:focus {
            background-color: var(--secondary);
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(2px) scale(0.98);
        }
        
        .class-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .class-btn {
            background-color: var(--accent);
            min-width: 250px;
        }
        
        .content-area {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .sentence-container {
            margin-bottom: 40px;
            width: 100%;
        }
        
        .sentence {
            font-size: 2.5rem;
            margin-bottom: 30px;
            line-height: 1.5;
            color: var(--text);
            max-width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
            hyphens: auto;
            padding: 0 20px;
            text-align: center;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
        }
        
        .japanese {
            color: var(--secondary);
            margin-top: 20px;
            font-size: 2rem;
            max-width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
            hyphens: auto;
            padding: 0 20px;
            text-align: center;
            font-size: clamp(1.2rem, 3vw, 2rem);
        }
        
        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 10px;
            margin: 30px 0;
            height: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--primary));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .controls {
            display: flex;
            gap: 30px;
            margin-top: auto;
            padding-top: 20px;
            position: sticky;
            bottom: 0;
            background-color: var(--card-bg);
            z-index: 10;
            width: 100%;
            justify-content: center;
        }
        
        .nav-btn {
            font-size: 1.5rem;
            padding: 20px 35px;
            min-width: 200px;
        }
        
        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--card-bg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .exit-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background-color: var(--warning);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 101;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            min-width: 200px;
            min-height: 70px;
        }
        
        .exit-btn:hover, .exit-btn:focus {
            transform: scale(1.05);
            background-color: #e5177a;
        }
        
        *:focus {
            outline: 4px solid var(--accent);
            transform: scale(1.05);
            box-shadow: 0 0 0 4px var(--accent);
        }
        
        #initialMessage {
            font-size: 2rem;
            color: var(--secondary);
        }
        
        #storySelectorContainer {
            margin: 20px 0;
            display: none;
        }
        
        #storySelectorContainer label {
            font-size: 1.8rem;
            margin-right: 15px;
        }
        
        #storySelector {
            font-size: 1.8rem;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--primary);
        }
        
        #fileUpload {
            margin: 30px;
            text-align: center;
            display: none;
        }
        
        #fileUpload h3 {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        #lessonFile {
            display: none;
        }
        
        #fileNameDisplay {
            margin: 15px;
            font-size: 1.5rem;
        }

        /* Fruit game styles */
        .fruit-game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .fruit-game {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 600px;
        }

        .fruit-game h2 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .fruit-reels {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .fruit-reel {
            font-size: 5rem;
            background-color: white;
            border-radius: 10px;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                top: 100%;
            }
        }
    </style>
</head>
<body>
    <button id="exitBtn" class="exit-btn" style="display: none;">Exit</button>
    
    <div class="container" id="mainContainer">
        <div class="logo">
            <span class="logo-icon">üí¨</span>
            <span>Chatterbox</span>
        </div>
        
        <h1>English Learning System</h1>
        
        <div id="classSelector" class="class-selector">
            <button class="btn class-btn" data-class="C">C Class</button>
            <button class="btn class-btn" data-class="X">X Class</button>
            <button class="btn class-btn" data-class="HighSchool">High School</button>
            <button class="btn class-btn" data-class="Adult">Adult</button>
        </div>
        
        <div id="storySelectorContainer">
            <label for="storySelector">Select Story:</label>
            <select id="storySelector">
                <!-- Options will be added dynamically -->
            </select>
        </div>
        
        <div id="fileUpload">
            <h3>Or Upload Lesson File</h3>
            <input type="file" id="lessonFile" accept=".txt">
            <label for="lessonFile" class="btn" style="cursor: pointer; margin: 15px;">
                Choose File
            </label>
            <button id="loadFileBtn" class="btn" style="margin: 15px;">Load Selected File</button>
            <div id="fileNameDisplay"></div>
        </div>
        
<div class="content-area" style="display: none;" id="readingMode">
                <div class="sentence-container">
                    <div style="display: flex; align-items: center; justify-content: center;">
                        <div id="sentenceDisplay" class="sentence"></div>
                        <button id="playBtn" class="btn" style="margin-left: 20px; background: var(--primary); width: 80px; height: 80px; border-radius: 50%; font-size: 2rem;">‚ñ∂</button>
                    </div>
                    <div id="japaneseDisplay" class="japanese"></div>
                </div>
                
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                
                <div class="controls">
                    <button id="prevBtn" class="btn nav-btn">Previous</button>
                    <button id="fruitToggle" class="btn nav-btn fruit-toggle" style="background-color: var(--warning);">üé∞ Fruit Game OFF</button>
                    <button id="nextBtn" class="btn nav-btn">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentClass = null;
        let currentStory = null;
        let sentences = [];
        let currentSentenceIndex = 0;
        
        // Fruit game state variables
        let fruitGameEnabled = false;
        let fruitGameActive = false;
        let shouldAdvanceAfterGame = false;
        
        const categories = [
            { name: 'Fruits', items: ['üçé', 'üçä', 'üçá', 'üçã', 'üçâ', 'üçì', 'üçí', 'üçë', 'üçç', 'ü•ù'] },
            { name: 'Vegetables', items: ['ü•ï', 'ü•¶', 'üçÖ', 'ü•í', 'üåΩ', 'üçÜ', 'ü•¨', 'üßÖ', 'üßÑ', 'ü•î'] },
            { name: 'Nature', items: ['üå≤', 'üåµ', 'üåä', '‚õ∞Ô∏è', 'üåã', 'üèùÔ∏è', 'üåÖ', 'üåà', '‚ùÑÔ∏è', 'üå™Ô∏è'] },
            { name: 'Animals', items: ['üê∂', 'üê±', 'ü¶Å', 'üêØ', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêµ', 'ü¶Ñ'] },
            { name: 'Food', items: ['üçï', 'üçî', 'üå≠', 'üçü', 'üç£', 'üç©', 'üç™', 'üçø', 'üç¶', 'üç´'] },
            { name: 'Sports', items: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ', 'üèê', 'üé±', 'üèì', 'üè∏', 'ü•ä'] },
            { name: 'Vehicles', items: ['üöó', 'üöï', 'üöô', 'üöå', 'üöë', 'üöí', 'üöú', 'üö≤', 'üõµ', '‚úàÔ∏è'] },
            { name: 'Household', items: ['üõèÔ∏è', 'üõãÔ∏è', 'üö™', 'ü™ë', 'üõÅ', 'üöø', 'üßª', 'üßπ', 'üß¥', 'üî™'] },
            { name: 'Clothing', items: ['üëï', 'üëñ', 'üß•', 'üëó', 'üëî', 'üëö', 'üëü', 'üß¶', 'üß§', 'üé©'] },
            { name: 'Electronics', items: ['üì±', 'üíª', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üì∑', 'üé•', 'üì∫', 'üéÆ', '‚åö', 'üîå'] }
        ];

        // Lessons data (will be loaded from x.js and other class files)
        let lessonsData = {};
        
        // DOM elements
        const mainContainer = document.getElementById('mainContainer');
        const exitBtn = document.getElementById('exitBtn');
        const classButtons = document.querySelectorAll('.class-btn');
const readingMode = document.getElementById('readingMode');
        const sentenceDisplay = document.getElementById('sentenceDisplay');
        const japaneseDisplay = document.getElementById('japaneseDisplay');
        const progressBar = document.getElementById('progressBar');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const playBtn = document.getElementById('playBtn');
        const fileInput = document.getElementById('lessonFile');
        const loadFileBtn = document.getElementById('loadFileBtn');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const fruitToggle = document.getElementById('fruitToggle');
        const storySelectorContainer = document.getElementById('storySelectorContainer');
        const fileUpload = document.getElementById('fileUpload');
        
        // Initialize the app
        function init() {
            window.addEventListener('resize', () => {
                if (sentences.length > 0) {
                    const container = document.getElementById('contentContainer') || document;
                    adjustTextSize(container);
                }
            });

            // Set up event listeners
            classButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentClass = btn.dataset.class;
                    populateStorySelector(currentClass);
                });
            });
            
            prevBtn.addEventListener('click', showPreviousSentence);
            nextBtn.addEventListener('click', showNextSentence);
            playBtn.addEventListener('click', playCurrentSentence);
            exitBtn.addEventListener('click', exitFullscreen);
            fileInput.addEventListener('change', handleFileSelect);
            loadFileBtn.addEventListener('click', loadSelectedFile);
            fruitToggle.addEventListener('click', toggleFruitGame);
            
            // Set up keyboard navigation for TV remote
            document.addEventListener('keydown', handleRemoteInput);
            
            // Load voices when they become available
            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = function() {
                    console.log('Voices loaded');
                };
                
                // Some browsers need this to load voices
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.getVoices();
                }
            }
            
            // Load external data
            loadExternalData().then(() => {
                console.log('All external data loaded');
                // Focus the first class button
                if (classButtons.length > 0) {
                    classButtons[0].focus();
                }
            }).catch(error => {
                console.error('Error loading external data:', error);
                alert('Error loading required data files. Please check the console for details.');
            });
        }
        
        // Load all external data files
        function loadExternalData() {
            return Promise.all([
                loadVocabData(),
                loadLessonsData()
            ]);
        }
        
        // Load vocabulary data from vocab.js
        function loadVocabData() {
            return new Promise((resolve, reject) => {
                if (typeof vocab !== 'undefined') {
                    console.log('Vocabulary data loaded');
                    resolve();
                } else {
                    const error = 'Vocabulary data not found. Please ensure vocab.js is loaded.';
                    console.error(error);
                    reject(error);
                }
            });
        }
        
        // Load lessons data from various class files
        function loadLessonsData() {
            return new Promise((resolve, reject) => {
                try {
                    // Load X class data
                    if (typeof x !== 'undefined') {
                        lessonsData['X'] = x;
                        console.log('X class data loaded');
                    }
                    
                    // Load C class data
                    if (typeof c !== 'undefined') {
                        lessonsData['C'] = c;
                        console.log('C class data loaded');
                    }
                    
                    // Load Adult class data
                    if (typeof adult !== 'undefined') {
                        lessonsData['Adult'] = adult;
                        console.log('Adult class data loaded');
                    }
                    
                    if (Object.keys(lessonsData).length > 0) {
                        resolve();
                    } else {
                        const error = 'No lesson data found. Please ensure at least one class file is loaded.';
                        console.error(error);
                        reject(error);
                    }
                } catch (e) {
                    reject(e);
                }
            });
        }
        
        // Adjust text size to fit container
        function adjustTextSize(container) {
            const sentenceElement = container.querySelector('#sentenceDisplay');
            const japaneseElement = container.querySelector('#japaneseDisplay');
            
            // Reset to default sizes first
            sentenceElement.style.fontSize = '';
            japaneseElement.style.fontSize = '';
            
            // Function to check if element is overflowing
            function isOverflowing(el) {
                return el.scrollHeight > el.clientHeight || el.scrollWidth > el.clientWidth;
            }
            
            // Adjust English sentence
            let fontSize = window.getComputedStyle(sentenceElement).fontSize;
            let currentSize = parseFloat(fontSize);
            
            while (isOverflowing(sentenceElement) && currentSize > 20) {
                currentSize -= 2;
                sentenceElement.style.fontSize = `${currentSize}px`;
            }
            
            // Adjust Japanese sentence
            fontSize = window.getComputedStyle(japaneseElement).fontSize;
            currentSize = parseFloat(fontSize);
            
            while (isOverflowing(japaneseElement) && currentSize > 16) {
                currentSize -= 2;
                japaneseElement.style.fontSize = `${currentSize}px`;
            }
        }
        
        // Populate story selector for the selected class
        function populateStorySelector(cls) {
            const storySelector = document.getElementById('storySelector');
            storySelector.innerHTML = '';
            
            if (lessonsData[cls]) {
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select a Story --';
                storySelector.appendChild(defaultOption);
                
                // Add story options
                Object.keys(lessonsData[cls]).forEach(storyKey => {
                    const option = document.createElement('option');
                    option.value = storyKey;
                    option.textContent = `Story ${storyKey.replace('story', '')}`;
                    storySelector.appendChild(option);
                });
                
                // Show the selector and file upload
                storySelectorContainer.style.display = 'block';
                fileUpload.style.display = 'block';
                
                // Focus the selector
                storySelector.focus();
                
                // Add event listener
                storySelector.onchange = function() {
                    currentStory = this.value;
                    if (currentStory) {
                        enterContentMode(cls);
                    }
                };
            }
        }
        
        // Enter fullscreen content mode
        function enterContentMode(cls) {
            // Hide main container and show exit button
            mainContainer.style.display = 'none';
            exitBtn.style.display = 'block';
            
            // Create fullscreen content container
            const contentContainer = document.createElement('div');
            contentContainer.className = 'fullscreen-mode';
            contentContainer.id = 'contentContainer';
            document.body.appendChild(contentContainer);
            
            // Clone the reading content
            const clonedContent = readingMode.cloneNode(true);
            clonedContent.style.display = 'block';
            contentContainer.appendChild(clonedContent);
            
            // Initialize the content
            loadTextContent(cls);
            
            // Set up event listeners for the cloned elements
            const containerPrevBtn = contentContainer.querySelector('#prevBtn');
            const containerNextBtn = contentContainer.querySelector('#nextBtn');
            const containerPlayBtn = contentContainer.querySelector('#playBtn');
            const containerFruitToggleBtn = contentContainer.querySelector('#fruitToggle');
            
            containerPrevBtn.addEventListener('click', showPreviousSentence);
            containerNextBtn.addEventListener('click', showNextSentence);
            containerPlayBtn.addEventListener('click', playCurrentSentence);
            containerFruitToggleBtn.addEventListener('click', toggleFruitGame);
            
            // Update the fruit toggle button state
            updateFruitButtonState();
        }
        
        // Exit fullscreen mode
        function exitFullscreen() {
            // Remove content container
            const contentContainer = document.getElementById('contentContainer');
            if (contentContainer) contentContainer.remove();
            
            // Show main container and hide exit button
            mainContainer.style.display = 'block';
            exitBtn.style.display = 'none';
            
            // Stop any speech
            stopSpeech();
            
            // Focus the class buttons
            setTimeout(() => {
                if (classButtons.length > 0) {
                    classButtons[0].focus();
                }
            }, 100);
        }
        
        // Load text content for reading mode
        function loadTextContent(cls) {
            if (lessonsData[cls] && currentStory && lessonsData[cls][currentStory]) {
                sentences = parseStoryFile(lessonsData[cls][currentStory]);
                if (sentences.length > 0) {
                    currentSentenceIndex = 0;
                    displayCurrentSentence(true);
                    console.log(`Loaded ${sentences.length} sentences for class ${cls}, story ${currentStory}`);
                } else {
                    alert(`No valid sentences found for class ${cls}, story ${currentStory}`);
                    exitFullscreen();
                }
            } else {
                alert(`Story data not found for class ${cls}, story ${currentStory}`);
                exitFullscreen();
            }
        }
        
        // Parse story file content
        function parseStoryFile(text) {
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0 && !line.startsWith('#'));
            
            const result = [];
            let englishLine = null;
            
            for (const line of lines) {
                if (/[a-zA-Z]/.test(line)) {
                    // English line
                    englishLine = line;
                } else if (englishLine) {
                    // Japanese line (following an English line)
                    result.push({
                        english: englishLine,
                        japanese: line,
                        number: result.length + 1
                    });
                    englishLine = null;
                }
            }
            
            return result;
        }
        
        // Display current sentence
        function displayCurrentSentence(isFullscreen = false) {
const container = isFullscreen ? document.getElementById('contentContainer') : document;
            
            const currentSentenceDisplay = container.querySelector('#sentenceDisplay');
            const currentJapaneseDisplay = container.querySelector('#japaneseDisplay');
            const currentProgressBar = container.querySelector('#progressBar');
            const currentPrevBtn = container.querySelector('#prevBtn');
            const currentNextBtn = container.querySelector('#nextBtn');
            
            if (!sentences || sentences.length === 0) {
                currentSentenceDisplay.textContent = "No sentences loaded";
                currentJapaneseDisplay.textContent = "";
                return;
            }
            
            const sentence = sentences[currentSentenceIndex];
            
            currentSentenceDisplay.textContent = `${sentence.number}. ${sentence.english}`;
            currentJapaneseDisplay.textContent = `${sentence.number}. ${sentence.japanese}`;
            
            // Update progress
            currentProgressBar.style.width = `${(currentSentenceIndex + 1) / sentences.length * 100}%`;
            
            // Update button states
            if (currentPrevBtn) currentPrevBtn.disabled = currentSentenceIndex <= 0;
            if (currentNextBtn) currentNextBtn.disabled = currentSentenceIndex >= sentences.length - 1;
            
            // Adjust text size if needed
            setTimeout(() => {
                adjustTextSize(container);
            }, 50);
        }
        
        // Play current sentence audio
        function playCurrentSentence() {
            if (sentences.length === 0 || fruitGameActive) return;
            
            const container = document.getElementById('contentContainer') || document;
            const currentSentenceDisplay = container.querySelector('#sentenceDisplay');
            const text = currentSentenceDisplay.textContent.replace(/^\d+\.\s/, '');
            
            // Stop any current speech and game sounds before starting new one
            stopSpeech();
            if (window.AudioContext) {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioCtx.close();
            }
            
            // Add slight delay to ensure speech is properly initialized
            setTimeout(() => {
                speakSentence(text);
            }, 100);
        }
        
        // Text-to-speech function
        function speakSentence(text) {
            // Don't read if it's an emoji
            if (/[\u{1F300}-\u{1F9FF}]/u.test(text)) {
                return;
            }
            
            if ('speechSynthesis' in window) {
                stopSpeech();
                
                // Create new utterance
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                
                // Remove any emoji descriptions from the text
                utterance.text = text.replace(/[\u{1F300}-\u{1F9FF}]/u, '').trim();
                
                // Set language and voice properties
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                // Try to find an American English voice
                const voices = window.speechSynthesis.getVoices();
                const usVoice = voices.find(voice => 
                    voice.lang === 'en-US' && voice.name.includes('US')
                );
                
                if (usVoice) {
                    utterance.voice = usVoice;
                }
                
                // Speak the utterance
                window.speechSynthesis.speak(utterance);
                
                // Error handling
                utterance.onerror = function(event) {
                    console.error('SpeechSynthesis error:', event);
                };
            } else {
                console.warn('Speech synthesis not supported');
            }
        }
        
        // Stop speech
        function stopSpeech() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }
        
        // Navigation functions
        function showNextSentence() {
            stopSpeech();
            if (sentences.length === 0 || fruitGameActive) return;
            
            // Show fruit game if enabled, but mark that we want to advance after
            if (fruitGameEnabled) {
                shouldAdvanceAfterGame = true;
                showFruitGame();
                return;
            }
                    
            // Normal advance to next sentence
            advanceToNextSentence();
        }
        
        function advanceToNextSentence() {
            if (currentSentenceIndex < sentences.length - 1) {
                currentSentenceIndex++;
            } else {
                currentSentenceIndex = 0; // Loop to beginning
            }
            
            displayCurrentSentence(true);
            playCurrentSentence();
        }
        
        function showPreviousSentence() {
            stopSpeech();
            if (sentences.length === 0) return;
            
            if (currentSentenceIndex > 0) {
                currentSentenceIndex--;
            } else {
                currentSentenceIndex = sentences.length - 1; // Loop to end
            }
            
            displayCurrentSentence(true);
            playCurrentSentence();
        }
        
        // Fruit game functions
        function updateFruitButtonState() {
            const buttons = document.querySelectorAll('.fruit-toggle');
            buttons.forEach(button => {
                button.textContent = fruitGameEnabled ? 'üé∞ Fruit Game ON' : 'üé∞ Fruit Game OFF';
                button.style.backgroundColor = fruitGameEnabled ? 'var(--success)' : 'var(--warning)';
            });
        }
        
        function toggleFruitGame() {
            fruitGameEnabled = !fruitGameEnabled;
            updateFruitButtonState();
            
            if (fruitGameEnabled) {
                playSound('activate');
                if (navigator.vibrate) navigator.vibrate(50);
            }
            
            console.log('Fruit game is now', fruitGameEnabled ? 'ON' : 'OFF');
        }
        
        function showFruitGame() {
            if (!fruitGameEnabled || fruitGameActive) {
                console.log('Fruit game not shown - enabled:', fruitGameEnabled, 'active:', fruitGameActive);
                return;
            }
            
            // Stop any current speech
            stopSpeech();
            fruitGameActive = true;
            
            // Create game container
            const gameContainer = document.createElement('div');
            gameContainer.className = 'fruit-game-container';
            gameContainer.innerHTML = `
                <div class="fruit-game">
                    <h2>Fruit Machine!</h2>
                    <div class="fruit-reels">
                        <div class="fruit-reel" id="reel1">üçé</div>
                        <div class="fruit-reel" id="reel2">üçä</div>
                        <div class="fruit-reel" id="reel3">üçá</div>
                    </div>
                    <div id="fruitResult" style="font-size: 2rem; min-height: 60px; margin: 20px 0;"></div>
                    <button id="exitFruitGame" class="btn" style="margin-top: 20px; background-color: var(--warning);">Exit Game</button>
                </div>
            `;
            
            document.body.appendChild(gameContainer);
            
            // Spin the reels
            spinReels();
            
            // Exit button
            document.getElementById('exitFruitGame').addEventListener('click', hideFruitGame);
        }
        
        function hideFruitGame() {
            const game = document.querySelector('.fruit-game-container');
            if (game) game.remove();
            fruitGameActive = false;
            
            // Stop any game sounds
            if (window.AudioContext) {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioCtx.close();
            }
            
            setTimeout(() => {
                if (shouldAdvanceAfterGame) {
                    // Only advance if Next was pressed before game started
                    advanceToNextSentence();
                    shouldAdvanceAfterGame = false;
                } else {
                    // Otherwise just refresh current sentence
                    displayCurrentSentence(true);
                    playCurrentSentence();
                }
            }, 500);
        }
        
        function spinReels() {
            // Select a random category for this spin
            const currentCategory = categories[Math.floor(Math.random() * categories.length)];
            const items = currentCategory.items;
            
            const reels = [
                document.getElementById('reel1'),
                document.getElementById('reel2'),
                document.getElementById('reel3')
            ];
            const resultDisplay = document.getElementById('fruitResult');
            
            // Reset display
            resultDisplay.textContent = '';
            resultDisplay.style.color = '';
            
            // Play spinning sound
            playSound('spin');
            
            // Determine if we should have a match (1 in 3 chance)
            const shouldMatch = Math.random() < 0.33;
            let matchingItem = '';
            
            if (shouldMatch) {
                matchingItem = items[Math.floor(Math.random() * items.length)];
            }
            
            // Spin each reel with delays between them
            spinReel(reels[0], 0, items, matchingItem, shouldMatch, () => {
                playSound('reelStop');
                spinReel(reels[1], 300, items, matchingItem, shouldMatch, () => {
                    playSound('reelStop');
                    spinReel(reels[2], 300, items, matchingItem, shouldMatch, () => {
                        playSound('reelStop');
                        
                        // Check for win after last reel stops
                        setTimeout(() => {
                            if (shouldMatch && reels[0].textContent === reels[1].textContent && 
                                reels[1].textContent === reels[2].textContent) {
                                // Win condition
                                playSound('win');
                                playSound('coin');
                                resultDisplay.textContent = 'üéâ WINNER! üéâ';
                                resultDisplay.style.color = 'var(--success)';
                                resultDisplay.style.fontWeight = 'bold';
                                
                                // Celebration animation
                                reels.forEach(reel => {
                                    reel.style.transform = 'scale(1.2)';
                                    reel.style.transition = 'all 0.3s';
                                    reel.style.boxShadow = '0 0 20px gold';
                                });
                                
                                // Confetti effect
                                setTimeout(() => {
                                    createConfetti();
                                }, 500);
                                
                                setTimeout(hideFruitGame, 3000);
                            } else {
                                // Lose condition
                                playSound('lose');
                                resultDisplay.textContent = 'Try again!';
                                resultDisplay.style.color = 'var(--warning)';
                                
                                // Shake animation
                                reels.forEach(reel => {
                                    reel.style.animation = 'shake 0.5s';
                                });
                                
                                setTimeout(hideFruitGame, 2000);
                            }
                        }, 300);
                    });
                });
            });
        }
        
        // Helper function to spin a single reel
function spinReel(reel, delay, items, matchingItem, shouldMatch, callback) {
    setTimeout(() => {
        let spins = 0;
        const spinInterval = setInterval(() => {
            // For the first few spins, show random items
            if (spins < 10) {
                reel.textContent = items[Math.floor(Math.random() * items.length)];
            } 
            // Then slow down to the final result
            else if (spins < 15) {
                if (spins % 2 === 0) {
                    reel.textContent = items[Math.floor(Math.random() * items.length)];
                }
            } 
            // Final result
            else {
                clearInterval(spinInterval);
                if (shouldMatch) {
                    reel.textContent = matchingItem;
                } else {
                    reel.textContent = items[Math.floor(Math.random() * items.length)];
                }
                if (callback) callback();
            }
            spins++;
        }, 100);
    }, delay);
}
        
        // Confetti effect for wins
        function createConfetti() {
            const container = document.querySelector('.fruit-game-container');
            if (!container) return;
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.borderRadius = '50%';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = '-10px';
                confetti.style.opacity = '0.8';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.animation = `confetti-fall ${2 + Math.random() * 3}s linear forwards`;
                
                container.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }
        
        // Handle file selection
        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                fileNameDisplay.textContent = `Selected: ${e.target.files[0].name}`;
            }
        }
        
        // Load selected file
        function loadSelectedFile() {
            if (fileInput.files.length === 0) {
                alert("Please select a file first!");
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                sentences = [];
                
                // Simple parsing - each pair of lines is English then Japanese
                const lines = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                for (let i = 0; i < lines.length; i += 2) {
                    if (i + 1 < lines.length) {
                        sentences.push({
                            english: lines[i],
                            japanese: lines[i+1],
                            number: (i/2) + 1
                        });
                    }
                }
                
                if (sentences.length > 0) {
                    currentSentenceIndex = 0;
                    displayCurrentSentence();
                    enterContentMode('uploaded');
                } else {
                    alert("No valid sentences found in the file!");
                }
            };
            
            reader.onerror = function() {
                alert("Error reading file. Please try another file.");
            };
            
            reader.readAsText(file);
        }
        
        // Handle TV remote input
        function handleRemoteInput(e) {
            const activeElement = document.activeElement;
            
            switch(e.key) {
                case 'ArrowUp':
                    navigateFocus('up');
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    navigateFocus('down');
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    if (activeElement === prevBtn || (activeElement.classList.contains('nav-btn') && activeElement.textContent.includes('Previous'))) {
                        showPreviousSentence();
                    } else {
                        navigateFocus('left');
                    }
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    if (activeElement === nextBtn || (activeElement.classList.contains('nav-btn') && activeElement.textContent.includes('Next'))) {
                        showNextSentence();
                    } else {
                        navigateFocus('right');
                    }
                    e.preventDefault();
                    break;
                case 'Enter':
                    if (activeElement) {
                        activeElement.click();
                    }
                    break;
                case 'Backspace':
                    exitFullscreen();
                    break;
            }
        }
        
        // Navigate focus between elements
        function navigateFocus(direction) {
            const focusable = Array.from(document.querySelectorAll('button, [tabindex="0"]'));
            const currentIndex = focusable.indexOf(document.activeElement);
            
            if (currentIndex === -1) {
                if (focusable.length > 0) focusable[0].focus();
                return;
            }
            
            let nextIndex = currentIndex;
            
            // Simple navigation - can be enhanced for grid layouts
            if (direction === 'up' || direction === 'left') {
                nextIndex = Math.max(0, currentIndex - 1);
            } else {
                nextIndex = Math.min(focusable.length - 1, currentIndex + 1);
            }
            
            focusable[nextIndex].focus();
        }
        
        // Play sound effects
        function playSound(type) {
            if (!window.AudioContext) return;
            
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            let oscillator = audioCtx.createOscillator();
            let gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            // Different sounds for different events
            switch(type) {
                case 'spin':
                    // Continuous spinning sound
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.5);
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.8);
                    break;
                    
                case 'reelStop':
                    // Short click when a reel stops
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    break;
                    
                case 'win':
                    // Winning fanfare
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2); // G5
                    oscillator.frequency.setValueAtTime(1046.5, audioCtx.currentTime + 0.3); // C6
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.5);
                    break;
                    
                case 'lose':
                    // Sad trombone
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(349.23, audioCtx.currentTime); // F4
                    oscillator.frequency.exponentialRampToValueAtTime(261.63, audioCtx.currentTime + 0.5); // C4
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.6);
                    break;
                    
                case 'activate':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(784, audioCtx.currentTime); // G5
                    oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.2); // C6
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                    
                case 'coin':
                    // Coin sound for wins
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(988, audioCtx.currentTime); // B5
                    oscillator.frequency.exponentialRampToValueAtTime(1318, audioCtx.currentTime + 0.1); // E6
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.2);
                    break;
            }
        }
        
        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
    
    <!-- Load external scripts -->
    <script src="vocab.js"></script>
    <script src="x.js"></script>
    <script src="c.js"></script>
    <script src="adult.js"></script>
</body>
</html>
