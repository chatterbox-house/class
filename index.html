<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterbox English Learning</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* [Previous CSS styles remain exactly the same] */
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #7209b7;
            --text: #2b2d42;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            font-size: 24px;
            background-image: radial-gradient(circle at 10% 20%, rgba(67, 97, 238, 0.1) 0%, rgba(72, 149, 239, 0.1) 90%);
        }
        
        .container {
            width: 95%;
            max-width: 1200px;
            text-align: center;
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--warning));
        }
        
        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon {
            margin-right: 15px;
            font-size: 3rem;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 2.8rem;
            font-weight: 700;
            position: relative;
            display: inline-block;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 5px;
            background: var(--accent);
            border-radius: 3px;
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 25px 40px;
            font-size: 1.8rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 300px;
            min-height: 100px;
            margin: 15px;
            box-shadow: 0 6px 10px rgba(0,0,0,0.1);
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover, .btn:focus {
            background-color: var(--secondary);
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(2px) scale(0.98);
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .class-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .class-btn {
            background-color: var(--accent);
            min-width: 250px;
        }
        
        .category-selector {
            margin-bottom: 30px;
        }
        
        .category-btn {
            background-color: var(--info);
            min-width: 300px;
            margin: 0 15px;
        }
        
        .content-area {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .sentence-container {
            margin-bottom: 40px;
            width: 100%;
        }
        
        .sentence {
            font-size: 2.5rem;
            margin-bottom: 30px;
            line-height: 1.5;
            color: var(--text);
        }
        
        .japanese {
            color: var(--secondary);
            margin-top: 20px;
            font-size: 2rem;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 10px;
            margin: 30px 0;
            height: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--primary));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .controls {
            display: flex;
            gap: 30px;
            margin-top: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-btn {
            font-size: 1.5rem;
            padding: 20px 35px;
            min-width: 200px;
        }
        
        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--card-bg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .exit-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background-color: var(--warning);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 101;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            min-width: 200px;
            min-height: 70px;
        }
        
        .exit-btn:hover, .exit-btn:focus {
            transform: scale(1.05);
            background-color: #e5177a;
        }
        
        *:focus {
            outline: 4px solid var(--accent);
            transform: scale(1.05);
            box-shadow: 0 0 0 4px var(--accent);
        }
        
        #initialMessage {
            font-size: 2rem;
            color: var(--secondary);
        }
        
        .game-area {
            display: none;
            margin-top: 40px;
            width: 100%;
            background: rgba(67, 97, 238, 0.05);
            border-radius: 15px;
            padding: 30px;
        }
        
/* Matching Game Styles */
.matching-container {
    display: flex;
    justify-content: center;
    gap: 50px;
    width: 100%;
}

.emoji-column, .word-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.emoji-btn {
    font-size: 3rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 15px;
    width: 150px;
    height: 150px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.emoji-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.word-item {
    font-size: 1.8rem;
    background: var(--accent);
    color: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    cursor: grab;
    user-select: none;
    transition: all 0.3s;
}

.word-item:active {
    cursor: grabbing;
}

.word-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.1);
}

#messageDisplay {
    font-size: 2rem;
    margin-top: 30px;
    min-height: 60px;
    text-align: center;
    transition: all 0.3s;
}

/* Success state */
.emoji-btn.matched {
    background: var(--success);
    cursor: default;
    pointer-events: none;
}

/* Drag state */
.word-item.dragging {
    opacity: 0.7;
    transform: scale(0.95);
}

/* Drop target highlight */
.emoji-btn.drop-target {
    transform: scale(1.1);
    box-shadow: 0 0 0 3px var(--accent);
}
        }
    </style>
</head>
<body>
    <button id="exitBtn" class="exit-btn" style="display: none;">Exit</button>
    
    <div class="container" id="mainContainer">
        <div class="logo">
            <span class="logo-icon">ðŸ’¬</span>
            <span>Chatterbox</span>
        </div>
        
        <h1>English Learning System</h1>
        
        <div class="mode-selector">
            <button id="readingBtn" class="btn">Reading Mode</button>
            <button id="matchingBtn" class="btn">Matching Game</button>
        </div>
        
        <div id="categorySelector" class="category-selector" style="display: none;">
            <button id="concreteBtn" class="btn category-btn">Concrete Words</button>
            <button id="abstractBtn" class="btn category-btn">Abstract Words</button>
        </div>
        
        <div id="classSelector" class="class-selector">
            <!-- Class buttons will be added dynamically -->
        </div>
        <div id="storySelectorContainer" style="display: none; margin: 20px 0;">
    <label for="storySelector" style="font-size: 1.8rem; margin-right: 15px;">Select Story:</label>
    <select id="storySelector" style="font-size: 1.8rem; padding: 10px; border-radius: 8px; border: 2px solid var(--primary);">
        <!-- Options will be added dynamically -->
    </select>
</div>
        <div id="fileUpload" style="display: none; margin: 30px; text-align: center;">
            <h3 style="font-size: 2rem; margin-bottom: 20px;">Or Upload Lesson File</h3>
            <input type="file" id="lessonFile" accept=".txt" style="display: none;">
            <label for="lessonFile" class="btn" style="cursor: pointer; margin: 15px;">
                Choose File
            </label>
            <button id="loadFileBtn" class="btn" style="margin: 15px;">Load Selected File</button>
            <div id="fileNameDisplay" style="margin: 15px; font-size: 1.5rem;"></div>
        </div>
        
        <div class="content-area">
            <div id="initialMessage">
                <p>Please select a mode and class to begin</p>
            </div>
            
            <div id="readingMode" style="display: none;">
                <div class="sentence-container">
                    <div style="display: flex; align-items: center; justify-content: center;">
                        <div id="sentenceDisplay" class="sentence"></div>
                        <button id="playBtn" class="btn" style="margin-left: 20px; background: var(--primary); width: 80px; height: 80px; border-radius: 50%; font-size: 2rem;">â–¶</button>
                    </div>
                    <div id="japaneseDisplay" class="japanese"></div>
                </div>
                
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                
                <div class="controls">
                    <button id="prevBtn" class="btn nav-btn">Previous</button>
                    <button id="nextBtn" class="btn nav-btn">Next</button>
                </div>
            </div>
            
            <div id="matchingGame" class="game-area">
                <h2 style="font-size: 2.5rem; margin-bottom: 30px;">Match the Words</h2>
                <div id="cardsContainer" class="cards-container">
                    <!-- Cards will be added dynamically -->
                </div>
                <div id="scoreDisplay" class="score-display" style="background-color: var(--primary); color: white; padding: 15px 25px; border-radius: 50px; font-weight: 600; font-size: 1.8rem; margin-top: 30px;">Matches: 0/4</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentMode = null;
        let currentClass = null;
        let currentCategory = 'concrete';
        let sentences = [];
        let currentSentenceIndex = 0;
        let matchedPairs = 0;
        let selectedCards = [];
let currentStory = null;
        
        // Class data
const classes = {
    reading: ['X', 'C', 'HighSchool', 'Adult'],  // Added 'C' to the reading classes
    matching: ['T2', 'A', 'B']
};
        
        // Vocabulary data (will be loaded from vocab.js)
        let vocabData = [];
        
        // Lessons data (will be loaded from x.js and other class files)
        let lessonsData = {};
        
        // DOM elements
        const mainContainer = document.getElementById('mainContainer');
        const exitBtn = document.getElementById('exitBtn');
        const readingBtn = document.getElementById('readingBtn');
        const matchingBtn = document.getElementById('matchingBtn');
        const concreteBtn = document.getElementById('concreteBtn');
        const abstractBtn = document.getElementById('abstractBtn');
        const categorySelector = document.getElementById('categorySelector');
        const classSelector = document.getElementById('classSelector');
        const initialMessage = document.getElementById('initialMessage');
        const readingMode = document.getElementById('readingMode');
        const matchingGame = document.getElementById('matchingGame');
        const sentenceDisplay = document.getElementById('sentenceDisplay');
        const japaneseDisplay = document.getElementById('japaneseDisplay');
        const progressBar = document.getElementById('progressBar');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const playBtn = document.getElementById('playBtn');
        const cardsContainer = document.getElementById('cardsContainer');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const fileInput = document.getElementById('lessonFile');
        const loadFileBtn = document.getElementById('loadFileBtn');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        // Initialize the app
        function init() {
            // Set up event listeners
            readingBtn.addEventListener('click', () => setMode('reading'));
            matchingBtn.addEventListener('click', () => setMode('matching'));
            concreteBtn.addEventListener('click', () => setCategory('concrete'));
            abstractBtn.addEventListener('click', () => setCategory('abstract'));
            prevBtn.addEventListener('click', showPreviousSentence);
            nextBtn.addEventListener('click', showNextSentence);
            playBtn.addEventListener('click', playCurrentSentence);
            exitBtn.addEventListener('click', exitFullscreen);
            fileInput.addEventListener('change', handleFileSelect);
            loadFileBtn.addEventListener('click', loadSelectedFile);
            
            // Set up keyboard navigation for TV remote
            document.addEventListener('keydown', handleRemoteInput);
    // Load voices when they become available
    if ('speechSynthesis' in window) {
        window.speechSynthesis.onvoiceschanged = function() {
            console.log('Voices loaded');
        };
        
        // Some browsers need this to load voices
        if (window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.getVoices();
        }
    }
            
            // Load external data
            loadExternalData().then(() => {
                console.log('All external data loaded');
                readingBtn.focus();
            }).catch(error => {
                console.error('Error loading external data:', error);
                alert('Error loading required data files. Please check the console for details.');
            });
        }
        
        // Load all external data files
        function loadExternalData() {
            return Promise.all([
                loadVocabData(),
                loadLessonsData()
            ]);
        }
        
        // Load vocabulary data from vocab.js
        function loadVocabData() {
            return new Promise((resolve, reject) => {
                if (typeof vocab !== 'undefined') {
                    vocabData = vocab;
                    console.log('Vocabulary data loaded:', vocabData.length, 'items');
                    
                    // Verify the data format
                    if (vocabData.length > 0 && !vocabData[0].word) {
                        const error = 'Vocabulary data format incorrect. Expected array of objects with word/japanese properties.';
                        console.error(error);
                        reject(error);
                        return;
                    }
                    
                    resolve();
                } else {
                    const error = 'Vocabulary data not found. Please ensure vocab.js is loaded.';
                    console.error(error);
                    reject(error);
                }
            });
        }
        
        // Load lessons data from various class files
        function loadLessonsData() {
            return new Promise((resolve, reject) => {
                try {
                    // Load X class data
                    if (typeof x !== 'undefined') {
                        lessonsData['X'] = x;
                        console.log('X class data loaded');
                    }
// Add this to load C class data
if (typeof c !== 'undefined') {
    lessonsData['C'] = c;
    console.log('C class data loaded');
}
// Add this to load Adult class data
if (typeof adult !== 'undefined') {
    lessonsData['Adult'] = adult;
    console.log('Adult class data loaded');
}
                    
                    // Load other class data here as needed
                    // if (typeof highschool !== 'undefined') {
                    //     lessonsData['HighSchool'] = highschool;
                    // }
                    
                    if (Object.keys(lessonsData).length > 0) {
                        resolve();
                    } else {
                        const error = 'No lesson data found. Please ensure at least x.js is loaded.';
                        console.error(error);
                        reject(error);
                    }
                } catch (e) {
                    reject(e);
                }
            });
        }
        
        // Set the current mode (reading or matching)
function setMode(mode) {
    stopSpeech();
    currentMode = mode;
    
    // Hide all content areas
    initialMessage.style.display = 'none';
    readingMode.style.display = 'none';
    matchingGame.style.display = 'none';
    
    // Show category selector only for matching game
    categorySelector.style.display = mode === 'matching' ? 'block' : 'none';
    
    // Show file upload only for reading mode
    document.getElementById('fileUpload').style.display = mode === 'reading' ? 'block' : 'none';
    
    // Show story selector only for reading mode
    document.getElementById('storySelectorContainer').style.display = mode === 'reading' ? 'block' : 'none';
    
    // Update active buttons
    readingBtn.classList.toggle('active', mode === 'reading');
    matchingBtn.classList.toggle('active', mode === 'matching');
    
    // Create class buttons
    createClassButtons();
}

// Update the createClassButtons function to also create story options
function createClassButtons() {
    classSelector.innerHTML = '';
    
    const modeClasses = currentMode === 'reading' ? classes.reading : classes.matching;
    
    modeClasses.forEach(cls => {
        const btn = document.createElement('button');
        btn.className = 'btn class-btn';
        btn.textContent = cls;
        btn.addEventListener('click', () => {
            currentClass = cls;
            populateStorySelector(cls);
        });
        classSelector.appendChild(btn);
    });
}

// New function to populate story selector
function populateStorySelector(cls) {
    const storySelector = document.getElementById('storySelector');
    storySelector.innerHTML = '';
    
    if (lessonsData[cls]) {
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Select a Story --';
        storySelector.appendChild(defaultOption);
        
        // Add story options
        Object.keys(lessonsData[cls]).forEach(storyKey => {
            const option = document.createElement('option');
            option.value = storyKey;
            option.textContent = `Story ${storyKey.replace('story', '')}`;
            storySelector.appendChild(option);
        });
        
        // Add event listener
        storySelector.onchange = function() {
            currentStory = this.value;
            if (currentStory) {
                enterContentMode(cls);
            }
        };
        
        // Focus the selector
        storySelector.focus();
    }
}
        
        // Set the word category (concrete or abstract)
        function setCategory(category) {
            currentCategory = category;
            concreteBtn.classList.toggle('active', category === 'concrete');
            abstractBtn.classList.toggle('active', category === 'abstract');
        }
        
        // Enter fullscreen content mode
        function enterContentMode(cls) {
            currentClass = cls;
            
            // Hide main container and show exit button
            mainContainer.style.display = 'none';
            exitBtn.style.display = 'block';
            
            // Create fullscreen content container
            const contentContainer = document.createElement('div');
            contentContainer.className = 'fullscreen-mode';
            contentContainer.id = 'contentContainer';
            document.body.appendChild(contentContainer);
            
            // Clone the relevant content
            const contentToClone = currentMode === 'reading' ? readingMode : matchingGame;
            const clonedContent = contentToClone.cloneNode(true);
            clonedContent.style.display = 'block';
            contentContainer.appendChild(clonedContent);
            
            // Initialize the content - USING loadTextContent INSTEAD OF loadTextFile
            if (currentMode === 'reading') {
                loadTextContent(currentClass);  // This is the corrected function name
            } else {
                setupMatchingGame(currentClass);
            }
            
            // Set up event listeners for the cloned elements
            if (currentMode === 'reading') {
                const containerPrevBtn = contentContainer.querySelector('#prevBtn');
                const containerNextBtn = contentContainer.querySelector('#nextBtn');
                const containerPlayBtn = contentContainer.querySelector('#playBtn');
                
                containerPrevBtn.addEventListener('click', showPreviousSentence);
                containerNextBtn.addEventListener('click', showNextSentence);
                containerPlayBtn.addEventListener('click', playCurrentSentence);
            }
        }
        
        // Exit fullscreen mode
        function exitFullscreen() {
            // Remove content container
            const contentContainer = document.getElementById('contentContainer');
            if (contentContainer) contentContainer.remove();
            
            // Show main container and hide exit button
            mainContainer.style.display = 'block';
            exitBtn.style.display = 'none';
            
            // Stop any speech
            stopSpeech();
            
            // Focus the mode buttons
            setTimeout(() => {
                const activeModeBtn = currentMode === 'reading' ? readingBtn : matchingBtn;
                activeModeBtn.focus();
            }, 100);
        }
        
        // Load text content for reading mode
function loadTextContent(cls) {
    if (lessonsData[cls] && currentStory && lessonsData[cls][currentStory]) {
        sentences = parseStoryFile(lessonsData[cls][currentStory]);
        if (sentences.length > 0) {
            currentSentenceIndex = 0;
            displayCurrentSentence(true);
            console.log(`Loaded ${sentences.length} sentences for class ${cls}, story ${currentStory}`);
        } else {
            alert(`No valid sentences found for class ${cls}, story ${currentStory}`);
            exitFullscreen();
        }
    } else {
        alert(`Story data not found for class ${cls}, story ${currentStory}`);
        exitFullscreen();
    }
}
        
        // Parse story file content
        function parseStoryFile(text) {
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            let currentSection = null;
            const result = [];
            let englishLine = null;
            
            for (const line of lines) {
                if (line.startsWith('#STORY')) {
                    currentSection = 'story';
                    continue;
                } else if (line.startsWith('#QUESTIONS')) {
                    currentSection = 'questions';
                    continue;
                }
                
                if (!currentSection) continue;
                
                if (/[a-zA-Z]/.test(line)) {
                    englishLine = line;
                } else if (englishLine) {
                    result.push({
                        english: englishLine,
                        japanese: line,
                        section: currentSection,
                        number: result.length + 1
                    });
                    englishLine = null;
                }
            }
            
            return result;
        }
        
        // Display current sentence
        function displayCurrentSentence(isFullscreen = false) {
            const container = isFullscreen ? document.getElementById('contentContainer') : document;
            
            const currentSentenceDisplay = container.querySelector('#sentenceDisplay');
            const currentJapaneseDisplay = container.querySelector('#japaneseDisplay');
            const currentProgressBar = container.querySelector('#progressBar');
            const currentPrevBtn = container.querySelector('#prevBtn');
            const currentNextBtn = container.querySelector('#nextBtn');
            
            if (!sentences || sentences.length === 0) {
                currentSentenceDisplay.textContent = "No sentences loaded";
                currentJapaneseDisplay.textContent = "";
                return;
            }
            
            const sentence = sentences[currentSentenceIndex];
            
            currentSentenceDisplay.textContent = `${sentence.number}. ${sentence.english}`;
            currentJapaneseDisplay.textContent = `${sentence.number}. ${sentence.japanese}`;
            
            // Update progress
            currentProgressBar.style.width = `${(currentSentenceIndex + 1) / sentences.length * 100}%`;
            
            // Update button states
            if (currentPrevBtn) currentPrevBtn.disabled = currentSentenceIndex <= 0;
            if (currentNextBtn) currentNextBtn.disabled = currentSentenceIndex >= sentences.length - 1;
        }
        
        // Play current sentence audio
function playCurrentSentence() {
    if (sentences.length === 0) return;
    
    const container = document.getElementById('contentContainer') || document;
    const currentSentenceDisplay = container.querySelector('#sentenceDisplay');
    const text = currentSentenceDisplay.textContent.replace(/^\d+\.\s/, '');
    
    // Stop any current speech before starting new one
    stopSpeech();
    
    // Add slight delay to ensure speech is properly initialized
    setTimeout(() => {
        speakSentence(text);
    }, 100);
}
        
        // Text-to-speech function
function speakSentence(text) {
    if ('speechSynthesis' in window) {
        stopSpeech();
        
        // Create new utterance
        const utterance = new SpeechSynthesisUtterance(text);
        
        // Set language and voice properties
        utterance.lang = 'en-US';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        // Try to find an American English voice
        const voices = window.speechSynthesis.getVoices();
        const usVoice = voices.find(voice => 
            voice.lang === 'en-US' && voice.name.includes('US')
        );
        
        if (usVoice) {
            utterance.voice = usVoice;
        }
        
        // Speak the utterance
        window.speechSynthesis.speak(utterance);
        
        // Error handling
        utterance.onerror = function(event) {
            console.error('SpeechSynthesis error:', event);
        };
    } else {
        console.warn('Speech synthesis not supported');
    }
}
        
        // Stop speech
        function stopSpeech() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }
        
        // Navigation functions
        function showNextSentence() {
            stopSpeech();
            if (sentences.length === 0) return;
            
            if (currentSentenceIndex < sentences.length - 1) {
                currentSentenceIndex++;
            } else {
                currentSentenceIndex = 0; // Loop to beginning
            }
            
            displayCurrentSentence(true);
            playCurrentSentence();
        }
        
        function showPreviousSentence() {
            stopSpeech();
            if (sentences.length === 0) return;
            
            if (currentSentenceIndex > 0) {
                currentSentenceIndex--;
            } else {
                currentSentenceIndex = sentences.length - 1; // Loop to end
            }
            
            displayCurrentSentence(true);
            playCurrentSentence();
        }
        
   
 
// New matching game implementation
function setupMatchingGame(cls) {
    if (!vocabData || vocabData.length === 0) {
        alert('Vocabulary data not loaded. Please try again.');
        return;
    }

    // Get vocabulary for current category with emojis
    const filteredVocab = vocabData.filter(item => item.category === currentCategory && item.emoji);
    
    if (filteredVocab.length < 4) {
        alert(`Not enough ${currentCategory} vocabulary items with emojis (${filteredVocab.length} found, need 4). Please try another category.`);
        return;
    }

    // Select 4 random words with emojis
    const selectedWords = getRandomItems(filteredVocab, 4);
    
    // Clear and rebuild game area
    const contentContainer = document.getElementById('contentContainer');
    const gameArea = contentContainer.querySelector('#matchingGame');
    gameArea.innerHTML = `
        <h2 style="font-size: 2.5rem; margin-bottom: 30px;">Match the Emojis to Words</h2>
        <div class="matching-container">
            <div id="emojiColumn" class="emoji-column"></div>
            <div id="wordColumn" class="word-column"></div>
        </div>
        <div id="messageDisplay"></div>
    `;

    // Shuffle the words for the right column
    const shuffledWords = [...selectedWords].sort(() => 0.5 - Math.random());

    // Create emoji buttons (left column)
    const emojiColumn = gameArea.querySelector('#emojiColumn');
    selectedWords.forEach(word => {
        const emojiBtn = document.createElement('button');
        emojiBtn.className = 'emoji-btn';
        emojiBtn.innerHTML = word.emoji;
        emojiBtn.dataset.word = word.word;
        emojiBtn.addEventListener('click', () => {
            speakSentence(word.word);
        });
        emojiColumn.appendChild(emojiBtn);
    });

    // Create draggable word items (right column)
    const wordColumn = gameArea.querySelector('#wordColumn');
    shuffledWords.forEach(word => {
        const wordItem = document.createElement('div');
        wordItem.className = 'word-item';
        wordItem.textContent = word.word;
        wordItem.dataset.word = word.word;
        wordItem.draggable = true;
        
        wordItem.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', word.word);
            wordItem.classList.add('dragging');
        });
        
        wordItem.addEventListener('dragend', () => {
            wordItem.classList.remove('dragging');
        });
        
        wordColumn.appendChild(wordItem);
    });

    // Set up drop targets (emoji buttons)
    const emojiButtons = gameArea.querySelectorAll('.emoji-btn');
    emojiButtons.forEach(btn => {
        btn.addEventListener('dragover', (e) => {
            e.preventDefault();
            btn.classList.add('drop-target');
        });
        
        btn.addEventListener('dragleave', () => {
            btn.classList.remove('drop-target');
        });
        
        btn.addEventListener('drop', (e) => {
            e.preventDefault();
            btn.classList.remove('drop-target');
            
            const draggedWord = e.dataTransfer.getData('text/plain');
            const correctWord = btn.dataset.word;
            const messageDisplay = gameArea.querySelector('#messageDisplay');
            
            if (draggedWord === correctWord) {
                // Correct match
                playSound('correct');
                btn.classList.add('matched');
                btn.innerHTML = `${btn.innerHTML}<br>${word.word}`;
                
                // Find and hide the matched word
                const wordItems = gameArea.querySelectorAll('.word-item');
                wordItems.forEach(item => {
                    if (item.dataset.word === draggedWord) {
                        item.style.visibility = 'hidden';
                    }
                });
                
                messageDisplay.textContent = 'Correct!';
                messageDisplay.style.color = 'var(--success)';
                
                // Check if all matches are done
                const remainingEmojis = gameArea.querySelectorAll('.emoji-btn:not(.matched)');
                if (remainingEmojis.length === 0) {
                    setTimeout(() => {
                        playSound('celebrate');
                        messageDisplay.innerHTML = 'ðŸŽ‰ All matches correct! Well done! ðŸŽ‰';
                        setTimeout(exitFullscreen, 3000);
                    }, 500);
                }
            } else {
                // Incorrect match
                playSound('wrong');
                messageDisplay.textContent = 'Try again!';
                messageDisplay.style.color = 'var(--warning)';
            }
        });
    });
}

function playSound(type) {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let oscillator = audioCtx.createOscillator();
    let gainNode = audioCtx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    // Different sounds for different events
    switch(type) {
        case 'correct':
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            break;
        case 'wrong':
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); // A3
            oscillator.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 0.3);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            break;
        case 'celebrate':
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime); // E5
            oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.2);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            break;
    }
    
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5);
}
        
        // Update score display
        function updateScoreDisplay() {
            const contentContainer = document.getElementById('contentContainer');
            const currentScoreDisplay = contentContainer.querySelector('#scoreDisplay');
            
            currentScoreDisplay.textContent = `Matches: ${matchedPairs}/4`;
        }
        
        // Handle file selection
        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                fileNameDisplay.textContent = `Selected: ${e.target.files[0].name}`;
            }
        }
        
        // Load selected file
        function loadSelectedFile() {
            if (fileInput.files.length === 0) {
                alert("Please select a file first!");
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                sentences = [];
                
                // Simple parsing - each pair of lines is English then Japanese
                const lines = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                for (let i = 0; i < lines.length; i += 2) {
                    if (i + 1 < lines.length) {
                        sentences.push({
                            english: lines[i],
                            japanese: lines[i+1],
                            number: (i/2) + 1
                        });
                    }
                }
                
                if (sentences.length > 0) {
                    currentSentenceIndex = 0;
                    displayCurrentSentence();
                    enterContentMode('uploaded');
                } else {
                    alert("No valid sentences found in the file!");
                }
            };
            
            reader.onerror = function() {
                alert("Error reading file. Please try another file.");
            };
            
            reader.readAsText(file);
        }
        
        // Handle TV remote input
        function handleRemoteInput(e) {
            const activeElement = document.activeElement;
            
            switch(e.key) {
                case 'ArrowUp':
                    navigateFocus('up');
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    navigateFocus('down');
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    if (activeElement === prevBtn || (activeElement.classList.contains('nav-btn') && activeElement.textContent.includes('Previous'))) {
                        showPreviousSentence();
                    } else {
                        navigateFocus('left');
                    }
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    if (activeElement === nextBtn || (activeElement.classList.contains('nav-btn') && activeElement.textContent.includes('Next'))) {
                        showNextSentence();
                    } else {
                        navigateFocus('right');
                    }
                    e.preventDefault();
                    break;
                case 'Enter':
                    if (activeElement) {
                        activeElement.click();
                    }
                    break;
                case 'Backspace':
                    exitFullscreen();
                    break;
            }
        }
        
        // Navigate focus between elements
        function navigateFocus(direction) {
            const focusable = Array.from(document.querySelectorAll('button, [tabindex="0"]'));
            const currentIndex = focusable.indexOf(document.activeElement);
            
            if (currentIndex === -1) {
                if (focusable.length > 0) focusable[0].focus();
                return;
            }
            
            let nextIndex = currentIndex;
            
            // Simple navigation - can be enhanced for grid layouts
            if (direction === 'up' || direction === 'left') {
                nextIndex = Math.max(0, currentIndex - 1);
            } else {
                nextIndex = Math.min(focusable.length - 1, currentIndex + 1);
            }
            
            focusable[nextIndex].focus();
        }
        
        // Helper functions
        function getRandomItems(array, count) {
            if (!array || array.length === 0) return [];
            const shuffled = [...array].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, Math.min(count, array.length));
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
    
    <!-- Load external scripts -->
    <script src="vocab.js"></script>
    <script src="x.js"></script>
    <script src="c.js"></script>
    <script src="adult.js"></script>
    <!-- Add other class files as needed -->
    <!-- <script src="highschool.js"></script> -->
    <!-- <script src="adult.js"></script> -->
</body>
</html>
