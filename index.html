
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterbox House</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #5a7cff;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #7209b7;
            --text: #2b2d42;
            --text-light: #4a4d6b;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
            --dark-text: #e6e6e6;
            --dark-text-light: #b8b8b8;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100vw;
            padding: 20px;
            font-size: 16px;
            transition: var(--transition);
            line-height: 1.6;
        }
        
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }
        
.container {
    width: 95%;
    max-width: 1200px; /* Increased from 800px */
    text-align: center;
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 60px 40px; /* Increased padding */
    position: relative;
    overflow: hidden;
    transition: var(--transition);
    font-size: 1.2rem; /* Base font size increase */
}
        
        body.dark-mode .container {
            background-color: var(--dark-card);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .header {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: -0.5px;
        }
        
        body.dark-mode .header {
            color: var(--accent);
        }
        
        .controls-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            gap: 20px;
        }
        
        .dropdown {
            flex: 1;
            min-width: 0;
            position: relative;
        }
        
        select {
            width: 100%;
            padding: 15px 20px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            border: 2px solid var(--primary);
            background-color: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            appearance: none;
            transition: var(--transition);
        }
        
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        body.dark-mode select {
            background-color: var(--dark-card);
            color: var(--dark-text);
            border-color: var(--accent);
        }
        
        .dropdown:after {
            content: "▼";
            font-size: 0.8rem;
            color: var(--primary);
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        
        body.dark-mode .dropdown:after {
            color: var(--accent);
        }
        
        .file-upload-row {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 20px;
        }
        
        .file-input-container {
            flex: 1;
            position: relative;
            min-width: 0;
        }
        
        .file-input-label {
            display: block;
            width: 100%;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            background-color: var(--primary);
            color: white;
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
            border: 2px solid transparent;
        }
        
        .file-input-label:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .file-input-label:active {
            transform: translateY(0);
        }
        
        body.dark-mode .file-input-label {
            background-color: var(--accent);
        }
        
        body.dark-mode .file-input-label:hover {
            background-color: var(--primary-light);
        }
        
        #fileNameDisplay {
            font-size: 0.9rem;
            margin-top: 10px;
            color: var(--text-light);
            text-align: center;
        }
        
        body.dark-mode #fileNameDisplay {
            color: var(--dark-text-light);
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 0;
            border: 2px solid transparent;
        }
        
        .btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--text-light);
        }
        
        body.dark-mode .btn:disabled {
            background-color: var(--dark-text-light);
        }
        
        body.dark-mode .btn {
            background-color: var(--accent);
        }
        
        body.dark-mode .btn:hover {
            background-color: var(--primary-light);
        }
        
.night-mode-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: var(--dark);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: var(--transition);
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
        
        .night-mode-toggle:hover {
            transform: scale(1.1);
        }
        
        body.dark-mode .night-mode-toggle {
            background-color: var(--light);
            color: var(--dark);
        }

        /* READING MODE STYLES */
        .reading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--card-bg);
            color: var(--text);
            z-index: 100;
            overflow: hidden;
            padding: 15px;
            box-sizing: border-box;
            transition: var(--transition);
        }
        
        body.dark-mode .reading-container {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }
        
        /* Ensure all elements in reading mode respect dark mode */
        body.dark-mode .reading-header,
        body.dark-mode .reading-footer {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }
        
        body.dark-mode .sentence-display {
            color: var(--dark-text);
        }
        
        body.dark-mode .fruit-toggle {
            background-color: var(--success);
        }
        
        body.dark-mode .exit-reading {
            background-color: var(--warning);
        }
.reading-header {
    display: flex;
    justify-content: space-between;
    padding: 15px;
    align-items: center;
    position: relative;
}
.page-counter {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.9rem;
    color: var(--text-light);
    font-weight: 600;
}

body.dark-mode .page-counter {
    color: var(--dark-text-light);
}

.exit-reading {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top: 15px;
    background-color: var(--warning);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 10;
}
        
.fruit-toggle {
    background-color: var(--warning);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    flex-shrink: 0; /* Prevent button from growing */
    margin: 0 5px; /* Add some horizontal spacing */
}

.fruit-toggle.on {
    background-color: var(--success);
}
        
        .reel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .fruit-name {
            font-size: 1.2rem;
            height: 30px;
            text-align: center;
            color: var(--primary);
            font-weight: bold;
            min-width: 100px;
        }
        
.reading-content {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: calc(100% - 120px); /* Reduced to account for smaller footer */
    padding: 0 20px;
    overflow: hidden;
    margin-bottom: 60px; /* Space for fixed footer */
}
        
        .sentence-row {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 10px 20px; /* More side padding */
            width: 100%;
            overflow: hidden;
            min-height: 0;
            box-sizing: border-box;
            max-height: 50vh; /* Prevent overlap with header/footer */
        }
        
        .sentence-row:first-child {
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        body.dark-mode .sentence-row:first-child {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
.sentence-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    position: relative;
}

.play-btn {
    background-color: var(--primary);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    min-width: 40px;
    border-radius: 50%;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-right: 10px;
}

/* Update the sentence display to take remaining space */
.sentence-display {
    font-size: 5vw;
    line-height: 1.4;
    text-align: left;
    word-break: break-word;
    overflow: hidden;
    width: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 5px;
    box-sizing: border-box;
    white-space: normal;
    min-height: 0;
    flex: 1;
    max-height: 100%;
    text-overflow: ellipsis;
    overflow-wrap: break-word;
    hyphens: auto;
    max-width: 100%;
}
        
.reading-footer {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    align-items: center;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
    background-color: var(--card-bg);
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    transition: background-color 0.3s;
    height: 60px; /* Reduced height */
    gap: 10px; /* Add space between items */
}
        
        body.dark-mode .reading-footer {
            background-color: var(--dark-card);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
        }
        
.nav-btn {
    flex-shrink: 0; /* Prevent buttons from growing */
    background-color: var(--primary);
    color: white;
    border: none;
    width: 50px; /* Reduced size */
    height: 50px; /* Reduced size */
    border-radius: 50%;
    font-size: 1.2rem; /* Smaller font */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.2s;
    position: relative;
    z-index: 20;
    margin: 0 10px; /* Added some spacing */
}

        .nav-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
.font-controls {
    display: flex;
    gap: 5px;
}

.font-btn {
    background-color: var(--primary);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.2s;
}

.font-btn:hover {
    background-color: var(--primary-light);
    transform: scale(1.05);
}

body.dark-mode .font-btn {
    background-color: var(--accent);
}

body.dark-mode .font-btn:hover {
    background-color: var(--primary-light);
}

        .nav-btn:active {
            transform: scale(0.98);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Translation Popup Styles */
        .translation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            background-color: var(--card-bg);
            color: var(--text);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            padding: 30px;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode .translation-popup {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }
.language-label {
    font-size: 1.2rem;
    margin-bottom: 5px;
    color: var(--primary);
    font-weight: bold;
}

body.dark-mode .language-label {
    color: var(--accent);
}

        .translation-original {
            font-size: 2.5rem !important;
            margin-bottom: 20px !important;
            padding: 20px !important;
            background-color: rgba(0,0,0,0.05) !important;
            border-radius: 12px !important;
        }

        .translation-result {
            font-size: 2.5rem !important;
            padding: 20px !important;
            background-color: rgba(67, 97, 238, 0.1) !important;
            border-radius: 12px !important;
        }

        .translation-tts {
            font-size: 2rem !important;
            padding: 15px 25px !important;
            margin-top: 25px !important;
        }

        .translation-popup-header h3 {
            font-size: 2.5rem !important;
        }

        .translation-popup-close {
            width: 50px !important;
            height: 50px !important;
            font-size: 2rem !important;
        }

        .translation-popup.active {
            display: block;
        }

        .translation-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .translation-popup-close {
            background-color: var(--warning);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .translation-content {
            margin-bottom: 15px;
        }

        .translation-original {
            font-size: 1.5rem;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .translation-result {
            font-size: 1.5rem;
            padding: 10px;
            background-color: rgba(67, 97, 238, 0.1);
            border-radius: 8px;
        }

        .translation-tts {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }

        .translation-tts:hover {
            background-color: var(--secondary);
        }

        .translation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .translation-overlay.active {
            display: block;
        }
@media (max-width: 768px) {
    .translation-popup {
        width: 95%;
        padding: 15px;
        max-height: 80vh;
    }
    
    .translation-original, .translation-result {
        font-size: 1.2rem !important;
        padding: 10px !important;
    }
    
    .translation-popup-header h3 {
        font-size: 1.5rem !important;
    }
    
    .translation-tts {
        font-size: 1rem !important;
        padding: 10px 15px !important;
    }
}
        
        /* Fruit Game Styles */
        .fruit-game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
.fruit-game {
    background-color: var(--card-bg);
    color: var(--text);
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 800px;
    width: 90%;
    transition: var(--transition);
}

body.dark-mode .fruit-game {
    background-color: var(--dark-card);
    color: var(--dark-text);
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
        
        .fruit-reels {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
.fruit-reel {
    font-size: 8rem;  /* Increased from 4rem */
    width: 150px;     /* Increased from 100px */
    height: 150px;    /* Increased from 100px */
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: var(--card-bg);
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: var(--transition);
}

body.dark-mode .fruit-reel {
    background-color: var(--dark-card);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

        
        /* Confetti animation */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-10px) rotate(0deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Shake animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @media (max-width: 800px) {
            .sentence-display {
                font-size: 32px !important; /* Minimum readable size */
            }
            
            .controls-row, .file-upload-row {
                flex-direction: column;
            }
            
            select, .btn, .file-input-label {
                font-size: 1.2rem;
                padding: 12px;
            }
            
            .header {
                font-size: 2rem;
                margin-bottom: 20px;
            }
            
    .fruit-reels {
        flex-wrap: wrap;  /* Allow reels to wrap on small screens */
        gap: 10px;
    }
    
    .fruit-reel {
        font-size: 4rem;  /* Slightly smaller */
        width: 90px;      /* Reduced from 120px */
        height: 90px;     /* Reduced from 120px */
    }
    
    .reel-container {
        margin-bottom: 15px;
    }
        }
        @media (max-width: 768px) {
    .sentence-row {
        flex-direction: row;
        align-items: center;
        padding: 5px;
    }
    
    .play-btn {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
        margin-right: 8px;
    }
    
@media (max-width: 768px) {
    .sentence-display {
        font-size: 1.5rem !important;  /* Increased from 1rem */
        padding: 5px;
        line-height: 1.4;
        min-height: 60px;  /* Ensure enough space for tapping */
    }
    
    .sentence-row {
        min-height: 80px;  /* More space for each sentence */
    }
}
            .container {
                padding: 30px 20px;
                width: 100%;
            }
            
            .controls-row, .file-upload-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .header {
                font-size: 1.8rem;
                margin-bottom: 25px;
            }
            
            select, .btn, .file-input-label {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .night-mode-toggle {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }
@media (min-width: 1280px) {
    .nav-btn {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
    
    .reading-footer {
        height: 70px;
    }
    
    .reading-content {
        height: calc(100% - 130px);
        margin-bottom: 70px;
    }
}
/* Main container - only affects home screen */
#mainContainer.container {
    width: 95%;
    max-width: 1200px; /* Increased from 800px */
    padding: 60px 40px; /* Increased padding */
    font-size: 1.2rem; /* Base font size increase */
}

/* Only target header in main container */
#mainContainer .header {
    font-size: 4rem; /* Increased from 2.2rem */
    margin-bottom: 50px; /* Increased from 30px */
}

/* Only target dropdowns in main container */
#mainContainer .controls-row {
    display: flex;
    flex-direction: column; /* Stack vertically */
    margin-bottom: 25px;
    gap: 30px; /* Increased gap */
}

#mainContainer select {
    padding: 25px 30px; /* Increased from 15px 20px */
    font-size: 1.8rem; /* Increased from 1rem */
    border-width: 3px; /* Thicker border */
}

#mainContainer .dropdown:after {
    font-size: 1.5rem; /* Increased from 0.8rem */
    right: 30px; /* Adjusted position */
}

/* Larger screens adjustment */
@media (min-width: 1024px) {
    #mainContainer .header {
        font-size: 5rem;
        margin-bottom: 60px;
    }
    
    #mainContainer select {
        padding: 30px 35px;
        font-size: 2rem;
    }
    
    #mainContainer .dropdown:after {
        font-size: 2rem;
        right: 35px;
    }
}
    </style>
</head>
<body>
    <button class="night-mode-toggle" id="nightModeToggle">🌙</button>
    <div class="container" id="mainContainer">

        <div class="header">CHATTERBOX HOUSE</div>
        
        <div class="controls-row">
            <div class="dropdown">
<select id="classSelector">
    <option value="">Select Class</option>
    <option value="C">C Class</option>
    <option value="X">X Class</option>
    <option value="HighSchool">High School</option>
    <option value="Adult">Adult</option>
    <option value="Eiken3">Eiken 3</option>
    <option value="Eiken5">Eiken 5</option>
</select>
            </div>
            
            <div class="dropdown">
                <select id="storySelector" disabled>
                    <option value="">Select Story</option>
                </select>
            </div>
        </div>
        
    </div>

    <!-- READING MODE CONTAINER -->
    <div class="reading-container" id="readingModeContainer" style="display: none;">
<div class="reading-header">
    <div class="page-counter">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></div>
    <button id="exitReading" class="exit-reading">X</button>
</div>
        
        <div class="reading-content">
<div class="sentence-row">
    <div class="sentence-controls">
        <button id="playEnglish" class="play-btn">▶</button>
        <div id="englishSentence" class="sentence-display"></div>
    </div>
</div>

<div class="sentence-row">
    <div class="sentence-controls">
        <button id="playJapanese" class="play-btn">▶</button>
        <div id="japaneseSentence" class="sentence-display"></div>
    </div>
</div>
        
<div class="reading-footer">
    <button id="prevSentence" class="nav-btn">←</button>
    <div class="font-controls">
        <button id="decreaseFont" class="font-btn">A-</button>
        <button id="increaseFont" class="font-btn">A+</button>
    </div>
    <button id="fruitToggle" class="fruit-toggle">🎰 Fruit Game OFF</button>
    <button id="nextSentence" class="nav-btn">→</button>
</div>
    </div>

    <!-- Translation Popup -->
    <div class="translation-overlay" id="translationOverlay"></div>
<div class="translation-popup" id="translationPopup">
    <div class="translation-popup-header">
        <h3>TRANSLATION</h3>
        <button class="translation-popup-close" id="closeTranslationPopup">×</button>
    </div>
    <div class="translation-content">
        <div class="language-label" id="sourceLanguageLabel">English:</div>
        <div class="translation-original" id="translationOriginal"></div>
        
        <div class="language-label" id="targetLanguageLabel">Japanese:</div>
        <div class="translation-result" id="translationResult"></div>
        
        <button class="translation-tts" id="translationTts">
            <span>🔊 PLAY SOUND</span>
        </button>
    </div>
</div>
    
    <!-- Load external scripts -->
<script src="vocab.js"></script>
<script src="x.js"></script>
<script src="c.js"></script>
<script src="adult.js"></script>
<script src="QA5.js"></script>
<script src="eiken5story.js"></script>
<script src="eiken3.js"></script>
<script src="eiken3questions.js"></script>
<script src="easyquestions.js"></script>
<script src="gettingtoknow.js"></script>

    <script>
        // Global variables
        let currentClass = null;
        let currentStory = null;
        let sentences = [];
        let currentSentenceIndex = 0;
        let fruitGameEnabled = false;
        let fruitGameActive = false;
        let shouldAdvanceAfterGame = false;
        let isNightMode = false;
// Font size control variables
let currentFontSize = 5; // vw units by default
const minFontSize = 2; // vw
const maxFontSize = 8; // vw

        // Lessons data (will be loaded from x.js and other class files)
        let lessonsData = {};
        
        // DOM elements
        const mainContainer = document.getElementById('mainContainer');
        const readingModeContainer = document.getElementById('readingModeContainer');
        const englishSentence = document.getElementById('englishSentence');
        const japaneseSentence = document.getElementById('japaneseSentence');
        const prevSentenceBtn = document.getElementById('prevSentence');
        const nextSentenceBtn = document.getElementById('nextSentence');
        const playEnglishBtn = document.getElementById('playEnglish');
        const playJapaneseBtn = document.getElementById('playJapanese');
        const exitReadingBtn = document.getElementById('exitReading');
        const fruitToggleBtn = document.getElementById('fruitToggle');
        const classSelector = document.getElementById('classSelector');
        const storySelector = document.getElementById('storySelector');

        const nightModeToggle = document.getElementById('nightModeToggle');
        
        // Initialize the app
        function init() {
            // Set up event listeners
            classSelector.addEventListener('change', handleClassSelect);
    // Font size controls
    document.getElementById('increaseFont').addEventListener('click', increaseFontSize);
    document.getElementById('decreaseFont').addEventListener('click', decreaseFontSize);
    
    // Load saved font size
    const savedFontSize = parseFloat(localStorage.getItem('fontSize'));
    if (savedFontSize && !isNaN(savedFontSize)) {
        currentFontSize = Math.max(minFontSize, Math.min(maxFontSize, savedFontSize));
    }
            storySelector.addEventListener('change', handleStorySelect);

            nightModeToggle.addEventListener('click', toggleNightMode);
            prevSentenceBtn.addEventListener('click', showPreviousSentence);
            nextSentenceBtn.addEventListener('click', showNextSentence);
            playEnglishBtn.addEventListener('click', () => playSentence('english'));
            playJapaneseBtn.addEventListener('click', () => playSentence('japanese'));
            exitReadingBtn.addEventListener('click', exitReadingMode);
            fruitToggleBtn.addEventListener('click', toggleFruitGame);

            // Initialize translation elements
            initTranslationElements();

            // Set up keyboard navigation for TV remote
            document.addEventListener('keydown', handleRemoteInput);
            
            // Load voices when they become available
            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = function() {
                    console.log('Voices loaded');
                };
                
                // Some browsers need this to load voices
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.getVoices();
                }
            }
            
            // Load external data
            loadExternalData().then(() => {
                console.log('All external data loaded');
                // Focus the class selector
                classSelector.focus();
            }).catch(error => {
                console.error('Error loading external data:', error);
                alert('Error loading required data files. Please check the console for details.');
            });
        }
        
function increaseFontSize() {
    if (currentFontSize < maxFontSize) {
        currentFontSize += 0.5;
        applyFontSize();
    }
}

function decreaseFontSize() {
    if (currentFontSize > minFontSize) {
        currentFontSize -= 0.5;
        applyFontSize();
    }
}

function applyFontSize() {
    const displays = document.querySelectorAll('.sentence-display');
    displays.forEach(display => {
        display.style.fontSize = `${currentFontSize}vw`;
    });
    localStorage.setItem('fontSize', currentFontSize);
}
function updatePageCounter() {
    if (!sentences || sentences.length === 0) return;
    
    document.getElementById('currentPage').textContent = currentSentenceIndex + 1;
    document.getElementById('totalPages').textContent = sentences.length;
}

        function toggleNightMode() {
            isNightMode = !isNightMode;
            document.body.classList.toggle('dark-mode', isNightMode);
            nightModeToggle.textContent = isNightMode ? '☀️' : '🌙';
            
            // Save preference to localStorage
            localStorage.setItem('nightMode', isNightMode);
        }
        
        function handleClassSelect() {
            currentClass = this.value;
            storySelector.disabled = !currentClass;
            
            if (currentClass) {
                populateStorySelector(currentClass);
            } else {
                storySelector.innerHTML = '<option value="">Select Story</option>';
                storySelector.disabled = true;
            }
        }
        
function handleStorySelect() {
    currentStory = this.value;
    
    if (currentStory) {
        enterReadingMode(currentClass);
    }
}
        
        
        // Load all external data files
        function loadExternalData() {
            return Promise.all([
                loadVocabData(),
                loadLessonsData()
            ]);
        }
        
        // Load vocabulary data from vocab.js
        function loadVocabData() {
            return new Promise((resolve, reject) => {
                if (typeof vocab !== 'undefined') {
                    console.log('Vocabulary data loaded');
                    resolve();
                } else {
                    const error = 'Vocabulary data not found. Please ensure vocab.js is loaded.';
                    console.error(error);
                    reject(error);
                }
            });
        }
        
        // Load lessons data from various class files
function loadLessonsData() {
    return new Promise((resolve, reject) => {
        try {
            // Load X class data
            if (typeof x !== 'undefined') {
                lessonsData['X'] = x;
                console.log('X class data loaded');
            }
            
            // Load C class data
            if (typeof c !== 'undefined') {
                lessonsData['C'] = c;
                console.log('C class data loaded');
            }
            
            // Load Adult class data
            if (typeof adult !== 'undefined') {
                lessonsData['Adult'] = adult;
                console.log('Adult class data loaded');
            }
            
            // Load Eiken 3 data
            if (typeof eiken3 !== 'undefined' && typeof eiken3questions !== 'undefined') {
                lessonsData['Eiken3'] = {
                    'yukis_adventure': eiken3.yukis_adventure,
                    'questions': eiken3questions.questions
                };
                console.log('Eiken 3 class data loaded');
            }
            
            // Load Eiken 5 data
            if (typeof qa5 !== 'undefined' && typeof eiken5story !== 'undefined') {
                lessonsData['Eiken5'] = {
                    'questions': qa5.questions,
                    'sakis_park_day': eiken5story.sakis_park_day
                };
                console.log('Eiken 5 class data loaded');
            }
            
            // Load High School data
            if (typeof gettingtoknow !== 'undefined' && typeof easyquestions2 !== 'undefined') {
                lessonsData['HighSchool'] = {
                    'gettingtoknow': gettingtoknow.questions,
                    'easyquestions2': easyquestions2.questions
                };
                console.log('High School data loaded');
            }
            
            if (Object.keys(lessonsData).length > 0) {
                resolve();
            } else {
                const error = 'No lesson data found. Please ensure at least one class file is loaded.';
                console.error(error);
                reject(error);
            }
        } catch (e) {
            reject(e);
        }
    });
}
        
        // Populate story selector for the selected class
function populateStorySelector(cls) {
    storySelector.innerHTML = '<option value="">Select Story</option>';

    if (lessonsData[cls]) {
        // Special handling for High School
        if (cls === 'HighSchool') {
            // Option 1: Getting to Know You
            const option1 = document.createElement('option');
            option1.value = 'gettingtoknow';
            option1.textContent = '1. Getting to Know You';
            storySelector.appendChild(option1);
            
            // Option 2: Easy Questions (renamed from just "Easy Questions")
            const option2 = document.createElement('option');
            option2.value = 'easyquestions2';
            option2.textContent = '2. Easy Questions';
            storySelector.appendChild(option2);
        }
        // Special handling for Eiken 3
        else if (cls === 'Eiken3') {
            // Option 1: Questions
            const option1 = document.createElement('option');
            option1.value = 'questions';
            option1.textContent = '1. Questions';
            storySelector.appendChild(option1);
            
            // Option 2: Yuki's Adventure
            const option2 = document.createElement('option');
            option2.value = 'yukis_adventure';
            option2.textContent = '2. Yuki\'s Adventure';
            storySelector.appendChild(option2);
        }
        // Special handling for Eiken 5
        else if (cls === 'Eiken5') {
            // Option 1: Questions
            const option1 = document.createElement('option');
            option1.value = 'questions';
            option1.textContent = '1. Questions';
            storySelector.appendChild(option1);
            
            // Option 2: Saki's Park Day
            const option2 = document.createElement('option');
            option2.value = 'sakis_park_day';
            option2.textContent = '2. Saki\'s Park Day';
            storySelector.appendChild(option2);
        } 
        else {
            // Existing story options for other classes
            Object.keys(lessonsData[cls]).forEach(storyKey => {
                const option = document.createElement('option');
                option.value = storyKey;
                option.textContent = `Story ${storyKey.replace('story', '')}`;
                storySelector.appendChild(option);
            });
        }
        
        storySelector.disabled = false;
        storySelector.focus();
    }
}
        
        // Enter reading mode
        function enterReadingMode(cls) {
            // Hide main container and show reading container
            mainContainer.style.display = 'none';
            readingModeContainer.style.display = 'flex';
            
            // Initialize translation events
            initTranslationEvents();
            
            // Load the content
            loadTextContent(cls);
        }
        
        // Exit reading mode
        function exitReadingMode() {
            // Show main container and hide reading container
            mainContainer.style.display = 'block';
            readingModeContainer.style.display = 'none';
            
            // Stop any speech
            stopSpeech();
            
            // Focus the class selector
            setTimeout(() => {
                classSelector.focus();
            }, 100);
        }
        
        // Load text content for reading mode
function loadTextContent(cls) {
    if (lessonsData[cls] && currentStory && lessonsData[cls][currentStory]) {
        let content = lessonsData[cls][currentStory];
        
        // Parse the content (no randomization for any class)
        sentences = parseStoryFile(content);
        
        if (sentences.length > 0) {
            currentSentenceIndex = 0;
            updatePageCounter(); 
            displayCurrentSentence();
            console.log(`Loaded ${sentences.length} sentences for class ${cls}`);
        } else {
            alert(`No valid sentences found`);
            exitReadingMode();
        }
    } else {
        alert(`Data not found for class ${cls}`);
        exitReadingMode();
    }
}
        
        // Parse story file content
function parseStoryFile(text) {
    const lines = text.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0 && !line.startsWith('#'));
    
    const result = [];
    let englishLine = null;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Check if line contains English characters or emoji
        if (/[a-zA-Z]|\p{Emoji_Presentation}/u.test(line)) {
            englishLine = line;
        } else if (englishLine) {
            result.push({
                english: englishLine,
                japanese: line,
                number: result.length + 1
            });
            englishLine = null;
        }
    }
    
    return result;
}
        
function ensureTextVisibility() {
    const rows = document.querySelectorAll('.sentence-row');
    rows.forEach(row => {
        const display = row.querySelector('.sentence-display');
        if (!display) return;
        
        // Reset to default size first
        display.style.fontSize = '';
        
        // Check if text overflows
        if (display.scrollHeight > display.clientHeight || display.scrollWidth > display.clientWidth) {
            // Get current computed font size
            let fontSize = parseFloat(window.getComputedStyle(display).fontSize);
            
            // Reduce font size until text fits or minimum size reached
            while ((display.scrollHeight > display.clientHeight || 
                   display.scrollWidth > display.clientWidth) && 
                   fontSize > 12) { // Minimum font size of 12px
                fontSize -= 1;
                display.style.fontSize = `${fontSize}px`;
                
                // Force reflow to get updated dimensions
                void display.offsetHeight;
            }
        }
    });
}
        
        // Display current sentence
function displayCurrentSentence() {
    if (!sentences || sentences.length === 0) {
        englishSentence.textContent = "No sentences loaded";
        japaneseSentence.textContent = "";
        return;
    }

    const sentence = sentences[currentSentenceIndex];
    
    // Display with emoji but without number prefix
    englishSentence.textContent = sentence.english;
    japaneseSentence.textContent = sentence.japanese;
    
    // Reset font sizes before checking
    englishSentence.style.fontSize = '';
    japaneseSentence.style.fontSize = '';
    
    // Update button states
    prevSentenceBtn.disabled = false;
    nextSentenceBtn.disabled = false;
    
    // Immediately check and adjust text size
    ensureTextVisibility();
    // Apply current font size
    applyFontSize();
    
    updatePageCounter();
}

    function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}    
        // Play sentence audio
function playSentence(type) {
    if (sentences.length === 0 || fruitGameActive) return;
    
    const sentence = sentences[currentSentenceIndex];
    let text = type === 'english' ? sentence.english : sentence.japanese;
    const lang = type === 'english' ? 'en-US' : 'ja-JP';
    
    // Remove emoji from text to be spoken while keeping them visible
    const emojiRegex = /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/gu;
    text = text.replace(emojiRegex, '').trim();
    
    // Stop any current speech and sounds
    stopSpeech();
    
    // Speak the cleaned sentence
    speakSentence(text, lang);
}
 function stopSpeech() {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
}    
   
        // Text-to-speech function
function speakSentence(text, lang) {
    if (!('speechSynthesis' in window)) {
        console.warn('Speech synthesis not supported');
        return;
    }

    // Stop any current speech
    stopSpeech();

    // Create new utterance
    const utterance = new SpeechSynthesisUtterance(text);
    
    // Set language and voice properties
    utterance.lang = lang;
    utterance.rate = 0.9;
    utterance.pitch = 1;
    utterance.volume = 1;

    // Function to actually speak once voices are loaded
    const speakWithVoice = () => {
        const voices = window.speechSynthesis.getVoices();
        
        // Find the appropriate voice
        let voice;
        if (lang === 'en-US') {
            // First try to find a US English voice
            voice = voices.find(v => 
                v.lang === 'en-US' && 
                v.name.includes('English')
            );

            // If not found, try any English voice
            if (!voice) {
                voice = voices.find(v => 
                    v.lang.startsWith('en-')
                );
            }
        } else if (lang === 'ja-JP') {
            // For Japanese, find any Japanese voice
            voice = voices.find(v => 
                v.lang === 'ja-JP' || 
                v.lang.startsWith('ja')
            );
        }

        if (voice) {
            utterance.voice = voice;
            console.log('Using voice:', voice.name, 'for language:', lang);
        } else {
            console.warn('No specific voice found for', lang, 'using default');
        }

        // Error handling
        utterance.onerror = function(event) {
            console.error('SpeechSynthesis error:', event);
        };

        // Speak immediately
        window.speechSynthesis.speak(utterance);
    };

    // Check if voices are loaded
    const voices = window.speechSynthesis.getVoices();
    if (voices.length === 0) {
        console.log('Waiting for voices to load...');
        window.speechSynthesis.onvoiceschanged = speakWithVoice;
    } else {
        speakWithVoice();
    }
}
function listVoices() {
    const voices = window.speechSynthesis.getVoices();
    console.log("Available voices:");
    voices.forEach(voice => {
        console.log(`- ${voice.name} (${voice.lang}) ${voice.default ? '[DEFAULT]' : ''}`);
    });
}

// Run after page load
setTimeout(listVoices, 1000);
        // Navigation functions
function showNextSentence() {
    stopSpeech();
    closeTranslationPopupHandler();
    
    if (sentences.length === 0 || fruitGameActive) return;
    
    const isLastPage = currentSentenceIndex >= sentences.length - 1;
    
    // Always allow fruit game if enabled
    if (fruitGameEnabled) {
        shouldAdvanceAfterGame = true; // Always set to true - we'll handle last page in hideFruitGame
        showFruitGame();
        return;
    }
    
    // Handle last page case (only when fruit game is off)
    if (isLastPage) {
        currentSentenceIndex = 0; // Loop to beginning
        displayCurrentSentence();
        return;
    }
    
    // Normal case - go to next sentence
    advanceToNextSentence();
}
        function advanceToNextSentence() {
            if (currentSentenceIndex < sentences.length - 1) {
                currentSentenceIndex++;
            } else {
                currentSentenceIndex = 0; // Loop to beginning
            }
            
            displayCurrentSentence();
 updatePageCounter();
        }
        
function showPreviousSentence() {
    stopSpeech();
    closeTranslationPopupHandler(); // Close any open translation popup
    
    if (sentences.length === 0) return;
    
    if (currentSentenceIndex > 0) {
        currentSentenceIndex--;
    } else {
        currentSentenceIndex = sentences.length - 1; // Loop to end
    }
    
    displayCurrentSentence();
 updatePageCounter(); 
}
       
        
        // Handle TV remote input
        function handleRemoteInput(e) {
            const activeElement = document.activeElement;
            
            switch(e.key) {
                case 'ArrowUp':
                    navigateFocus('up');
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    navigateFocus('down');
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    if (activeElement === prevSentenceBtn) {
                        showPreviousSentence();
                    } else {
                        navigateFocus('left');
                    }
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    if (activeElement === nextSentenceBtn) {
                        showNextSentence();
                    } else {
                        navigateFocus('right');
                    }
                    e.preventDefault();
                    break;
                case 'Enter':
                    if (activeElement) {
                        activeElement.click();
                    }
                    break;
                case 'Backspace':
                    exitReadingMode();
                    break;
            }
        }
        
        // Navigate focus between elements
        function navigateFocus(direction) {
            const focusable = Array.from(document.querySelectorAll('button, select, [tabindex="0"]'));
            const currentIndex = focusable.indexOf(document.activeElement);
            
            if (currentIndex === -1) {
                if (focusable.length > 0) focusable[0].focus();
                return;
            }
            
            let nextIndex = currentIndex;
            
            // Simple navigation - can be enhanced for grid layouts
            if (direction === 'up' || direction === 'left') {
                nextIndex = Math.max(0, currentIndex - 1);
            } else {
                nextIndex = Math.min(focusable.length - 1, currentIndex + 1);
            }
            
            focusable[nextIndex].focus();
        }
        
// Translation state variables
let translationPopup, translationOverlay, closeTranslationPopup;
let translationOriginal, translationResult, translationTts;
let selectedText = '';
let translationLang = '';

// Initialize translation elements
function initTranslationElements() {
    translationPopup = document.getElementById('translationPopup');
    translationOverlay = document.getElementById('translationOverlay');
    closeTranslationPopup = document.getElementById('closeTranslationPopup');
    translationOriginal = document.getElementById('translationOriginal');
    translationResult = document.getElementById('translationResult');
    translationTts = document.getElementById('translationTts');
    
    if (!translationPopup || !translationOverlay || !closeTranslationPopup || 
        !translationOriginal || !translationResult || !translationTts) {
        console.error('One or more translation elements not found');
        return false;
    }
    
    // Reset state
    selectedText = '';
    translationLang = '';
    return true;
}

// Show translation popup
function showTranslationPopup(text, lang) {
    // Validate input
    const trimmedText = text.trim();
    if (!trimmedText || trimmedText.length < 1 || trimmedText.toLowerCase() === 'translate') {
        return;
    }
    
    // Reset previous state
    closeTranslationPopupHandler();
    
    // Set new translation data
    selectedText = trimmedText;
    translationLang = lang;
    
    // Update UI labels based on translation direction
    const sourceLabel = document.getElementById('sourceLanguageLabel');
    const targetLabel = document.getElementById('targetLanguageLabel');
    
    if (lang === 'en') {
        sourceLabel.textContent = 'English:';
        targetLabel.textContent = 'Japanese:';
    } else {
        sourceLabel.textContent = 'Japanese:';
        targetLabel.textContent = 'English:';
    }
    
    // Highlight the selected text
    try {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const span = document.createElement('span');
            span.className = 'highlighted-text';
            span.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
            range.surroundContents(span);
        }
    } catch (e) {
        console.error('Error highlighting text:', e);
    }
    
    // Update UI with original text
    translationOriginal.textContent = selectedText;
    translationResult.textContent = "Loading translation...";    
    // Update UI with original text
    translationOriginal.textContent = selectedText;
    translationResult.textContent = "Loading translation...";
    
    // Show popup
    translationPopup.classList.add('active');
    translationOverlay.classList.add('active');
    
    // Fetch translation
    fetchTranslation(selectedText, lang);
    
    // Add event listener to close popup when clicking Next button
    const nextBtn = document.getElementById('nextSentence');
    const prevBtn = document.getElementById('prevSentence');
    
    const closeOnNav = () => {
        closeTranslationPopupHandler();
        nextBtn.removeEventListener('click', closeOnNav);
        prevBtn.removeEventListener('click', closeOnNav);
    };
    
    nextBtn.addEventListener('click', closeOnNav);
    prevBtn.addEventListener('click', closeOnNav);
}

function closeTranslationPopupHandler() {
    if (!translationPopup || !translationOverlay) return;
    
    translationPopup.classList.remove('active');
    translationOverlay.classList.remove('active');
    stopSpeech();
    
    // Clear the translation fields
    translationOriginal.textContent = '';
    translationResult.textContent = '';
    
    // Reset selection state
    if (window.getSelection) {
        window.getSelection().removeAllRanges();
    }
    
    // Remove all highlights and restore original text
    document.querySelectorAll('.highlighted-text').forEach(el => {
        const parent = el.parentNode;
        while (el.firstChild) {
            parent.insertBefore(el.firstChild, el);
        }
        parent.removeChild(el);
        parent.normalize(); // Combine adjacent text nodes
    });
    
    // Reset translation variables
    selectedText = '';
    translationLang = '';
}

// Fetch translation from a free API
function fetchTranslation(text, lang) {
    // Correct format is "en|ja" (with pipe character, not dash)
    const langPair = lang === 'en' ? 'en|ja' : 'ja|en';
    
    // Encode the text and language pair properly
    const encodedText = encodeURIComponent(text);
    const encodedLangPair = encodeURIComponent(langPair);
    
    // Build the API URL
    const apiUrl = `https://api.mymemory.translated.net/get?q=${encodedText}&langpair=${encodedLangPair}`;
    
    // Use a reliable CORS proxy
    const proxyUrl = 'https://corsproxy.io/?';
    
    fetch(proxyUrl + apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.responseData && data.responseData.translatedText) {
                // Clean the translated text
                let translatedText = data.responseData.translatedText;
                
                // Remove unwanted characters and formatting
                translatedText = translatedText
                    .replace(/[#*_~`^]/g, '') // Remove special formatting chars
                    .replace(/\{.*?\}/g, '')   // Remove {tags}
                    .replace(/\[.*?\]/g, '')   // Remove [tags]
                    .replace(/\(.*?\)/g, '')   // Remove (tags)
                    .replace(/\d+/g, '')       // Remove numbers
                    .trim();
                
                // If the result is empty after cleaning, show an error
                if (!translatedText) {
                    throw new Error('Translation returned empty after cleaning');
                }
                
                translationResult.textContent = translatedText;
            } else {
                throw new Error('No translation data received');
            }
        })
        .catch(error => {
            console.error('Translation error:', error);
            translationResult.textContent = "Unable to get translation";
            
            // Try a fallback method for simple words
            if (text.length < 20) {
                trySimpleDictionaryLookup(text, lang);
            }
        });
}

// Simple dictionary lookup for common words
function trySimpleDictionaryLookup(text, lang) {
    // Convert to lowercase for matching
    const word = text.toLowerCase();
    
    // English to Japanese dictionary
    const enToJaDict = {
        'shows': '番組',
        'show': '見せる',
        'hello': 'こんにちは',
        'goodbye': 'さようなら',
        'thank you': 'ありがとう',
        'please': 'お願いします'
        // Add more common words as needed
    };
    
    // Japanese to English dictionary
    const jaToEnDict = {
        'こんにちは': 'hello',
        'ありがとう': 'thank you',
        'お願いします': 'please',
        '番組': 'show',
        '見せる': 'show'
        // Add more common words as needed
    };
    
    // Try to find a match
    const dict = lang === 'en' ? enToJaDict : jaToEnDict;
    if (dict[word]) {
        translationResult.textContent = dict[word];
    } else {
        // If no match found, try partial matches
        for (const [key, value] of Object.entries(dict)) {
            if (word.includes(key)) {
                translationResult.textContent = value;
                return;
            }
        }
        translationResult.textContent = "Translation not found";
    }
}
 // Handle text selection - CORRECTED VERSION
        function handleTextSelection() {
            try {
                const selection = window.getSelection();
                if (!selection || selection.isCollapsed || selection.rangeCount === 0) {
                    return;
                }

                const selectedText = selection.toString().trim();
                if (!selectedText || selectedText.length < 1 || selectedText.toLowerCase() === 'translate') {
                    return;
                }

                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;

                // Check if selection is within our target elements
                const isEnglish = englishSentence.contains(container);
                const isJapanese = japaneseSentence.contains(container);
                if (!isEnglish && !isJapanese) {
                    closeTranslationPopupHandler();
                    return;
                }

                // Skip if selection is collapsed (no actual text)
                if (range.collapsed) {
                    closeTranslationPopupHandler();
                    return;
                }

                // Show translation immediately for the selected text
                showTranslationPopup(selectedText, isEnglish ? 'en' : 'ja');
            } catch (error) {
                console.error('Error in text selection handling:', error);
            }
        }
        
function initTranslationEvents() {
    // Initialize translation elements first
    if (!initTranslationElements()) return;

    // Click event for single words
    englishSentence.addEventListener('click', handleEnglishClick);
    japaneseSentence.addEventListener('click', handleJapaneseClick);
    
    // Selection event for phrases
    document.addEventListener('mouseup', handleTextSelection);
    
    // Close popup events
    closeTranslationPopup.addEventListener('click', closeTranslationPopupHandler);
    translationOverlay.addEventListener('click', closeTranslationPopupHandler);
    
    // TTS button
    translationTts.addEventListener('click', () => {
        if (selectedText && translationLang) {
            speakSentence(selectedText, translationLang === 'en' ? 'en-US' : 'ja-JP');
        }
    });
}

function handleEnglishClick(e) {
    if (e.target === englishSentence) {
        const word = getWordAtPoint(englishSentence, e.clientX, e.clientY);
        if (word) {
            showTranslationPopup(word, 'en');
        }
    }
}

function handleJapaneseClick(e) {
    if (e.target === japaneseSentence) {
        const word = getWordAtPoint(japaneseSentence, e.clientX, e.clientY);
        if (word) {
            showTranslationPopup(word, 'ja');
        }
    }
}

        // Helper function to get word at specific coordinates
        function getWordAtPoint(element, x, y) {
            const range = document.caretRangeFromPoint(x, y);
            if (!range) return null;
            
            range.expand('word');
            const word = range.toString().trim();
            return word || null;
        }
        
        // Fruit game categories
        const categories = [
    // VERB CATEGORIES (3 groups)
    { 
        name: 'Basic Actions', 
        items: [
            {emoji: '🏃', name: 'run'}, 
            {emoji: '🚶', name: 'walk'},
            {emoji: '🛌', name: 'sleep'},
            {emoji: '🍽️', name: 'eat'},
            {emoji: '🚿', name: 'wash'},
            {emoji: '📚', name: 'study'},
            {emoji: '🎸', name: 'play'},
            {emoji: '📖', name: 'read'},
            {emoji: '✍️', name: 'write'},
            {emoji: '🎤', name: 'sing'}
        ]
    },
    { 
        name: 'Daily Activities', 
        items: [
            {emoji: '🛒', name: 'shop'}, 
            {emoji: '🚴', name: 'ride'},
            {emoji: '🏊', name: 'swim'},
            {emoji: '🚗', name: 'drive'},
            {emoji: '🧹', name: 'clean'},
            {emoji: '🍳', name: 'cook'},
            {emoji: '💃', name: 'dance'},
            {emoji: '🚲', name: 'cycle'},
            {emoji: '🎮', name: 'game'},
            {emoji: '🎭', name: 'act'}
        ]
    },
    { 
        name: 'Movement Verbs', 
        items: [
            {emoji: '🏃‍♂️', name: 'jog'}, 
            {emoji: '🧗', name: 'climb'},
            {emoji: '🤸', name: 'jump'},
            {emoji: '🤾', name: 'throw'},
            {emoji: '🏌️', name: 'golf'},
            {emoji: '🏄', name: 'surf'},
            {emoji: '⛷️', name: 'ski'},
            {emoji: '🤽', name: 'dive'},
            {emoji: '🚣', name: 'row'},
            {emoji: '🛹', name: 'skate'}
        ]
    },

    // ADJECTIVE CATEGORIES (3 groups)
    { 
        name: 'Basic Descriptions', 
        items: [
            {emoji: '🌞', name: 'sunny'}, 
            {emoji: '❄️', name: 'cold'},
            {emoji: '🔥', name: 'hot'},
            {emoji: '💧', name: 'wet'},
            {emoji: '🌈', name: 'colorful'},
            {emoji: '⚡', name: 'fast'},
            {emoji: '🐌', name: 'slow'},
            {emoji: '🐘', name: 'big'},
            {emoji: '🐜', name: 'small'},
            {emoji: '❤️', name: 'happy'}
        ]
    },
    { 
        name: 'Personality Traits', 
        items: [
            {emoji: '😊', name: 'friendly'}, 
            {emoji: '🧠', name: 'smart'},
            {emoji: '💪', name: 'strong'},
            {emoji: '🦸', name: 'brave'},
            {emoji: '🤗', name: 'kind'},
            {emoji: '🤓', name: 'clever'},
            {emoji: '😴', name: 'sleepy'},
            {emoji: '🤡', name: 'silly'},
            {emoji: '👑', name: 'proud'},
            {emoji: '🧐', name: 'curious'}
        ]
    },
    { 
        name: 'Sensory Words', 
        items: [
            {emoji: '🍯', name: 'sweet'}, 
            {emoji: '🍋', name: 'sour'},
            {emoji: '🧂', name: 'salty'},
            {emoji: '☕', name: 'bitter'},
            {emoji: '🦔', name: 'rough'},
            {emoji: '🪶', name: 'soft'},
            {emoji: '🔊', name: 'loud'},
            {emoji: '🔇', name: 'quiet'},
            {emoji: '💡', name: 'bright'},
            {emoji: '🌑', name: 'dark'}
        ]
    },

    // NOUN CATEGORIES (4 groups)
    { 
        name: 'Everyday Objects', 
        items: [
            {emoji: '📖', name: 'a book'},
            {emoji: '✏️', name: 'a pencil'},
            {emoji: '💻', name: 'a computer'},
            {emoji: '📱', name: 'a phone'},
            {emoji: '⌚', name: 'a watch'},
            {emoji: '🔑', name: 'a key'},
            {emoji: '💡', name: 'a light'},
            {emoji: '🧸', name: 'a toy'},
            {emoji: '🧦', name: 'socks'},
            {emoji: '👓', name: 'glasses'}
        ]
    },
    { 
        name: 'Animals', 
        items: [
            {emoji: '🐶', name: 'a dog'},
            {emoji: '🐱', name: 'a cat'},
            {emoji: '🐰', name: 'a rabbit'},
            {emoji: '🦊', name: 'a fox'},
            {emoji: '🐻', name: 'a bear'},
            {emoji: '🦁', name: 'a lion'},
            {emoji: '🐯', name: 'a tiger'},
            {emoji: '🦄', name: 'a unicorn'},
            {emoji: '🐧', name: 'a penguin'},
            {emoji: '🦉', name: 'an owl'}
        ]
    },
    { 
        name: 'Food & Drink', 
        items: [
            {emoji: '🍎', name: 'an apple'}, 
            {emoji: '🍌', name: 'a banana'},
            {emoji: '🍕', name: 'a pizza'},
            {emoji: '🍔', name: 'a burger'},
            {emoji: '🍜', name: 'noodles'},
            {emoji: '🍦', name: 'ice cream'},
            {emoji: '🍩', name: 'a donut'},
            {emoji: '☕', name: 'coffee'},
            {emoji: '🍵', name: 'tea'},
            {emoji: '🥤', name: 'a drink'}
        ]
    },
    { 
        name: 'Places', 
        items: [
            {emoji: '🏠', name: 'a house'},
            {emoji: '🏫', name: 'a school'},
            {emoji: '🏥', name: 'a hospital'},
            {emoji: '🏖️', name: 'a beach'},
            {emoji: '🏞️', name: 'a park'},
            {emoji: '🏪', name: 'a store'},
            {emoji: '🏟️', name: 'a stadium'},
            {emoji: '⛪', name: 'a church'},
            {emoji: '🏰', name: 'a castle'},
            {emoji: '🌋', name: 'a volcano'}
        ]
    }
];

        // Fruit game functions
        function updateFruitButtonState() {
            fruitToggleBtn.textContent = fruitGameEnabled ? '🎰 Fruit Game ON' : '🎰 Fruit Game OFF';
            fruitToggleBtn.classList.toggle('on', fruitGameEnabled);
        }
        
        function toggleFruitGame() {
            fruitGameEnabled = !fruitGameEnabled;
            updateFruitButtonState();
            
            if (fruitGameEnabled) {
                playSound('activate');
                if (navigator.vibrate) navigator.vibrate(50);
            }
            
            console.log('Fruit game is now', fruitGameEnabled ? 'ON' : 'OFF');
        }
        
        function showFruitGame() {
            if (!fruitGameEnabled || fruitGameActive) {
                console.log('Fruit game not shown - enabled:', fruitGameEnabled, 'active:', fruitGameActive);
                return;
            }
            
            // Stop any current speech
            stopSpeech();
            fruitGameActive = true;
            
            // Create game container
            const gameContainer = document.createElement('div');
            gameContainer.className = 'fruit-game-container';
            gameContainer.innerHTML = `
                <div class="fruit-game">
                    <h2>Fruit Machine!</h2>
                    <div class="fruit-reels">
                        <div class="reel-container">
                            <div class="fruit-reel" id="reel1">🍎</div>
                            <div class="fruit-name" id="name1"></div>
                        </div>
                        <div class="reel-container">
                            <div class="fruit-reel" id="reel2">🍊</div>
                            <div class="fruit-name" id="name2"></div>
                        </div>
                        <div class="reel-container">
                            <div class="fruit-reel" id="reel3">🍇</div>
                            <div class="fruit-name" id="name3"></div>
                        </div>
                    </div>
                    <div id="fruitResult" style="font-size: 2rem; min-height: 60px; margin: 20px 0;"></div>
                    <button id="exitFruitGame" class="btn" style="margin-top: 20px; background-color: var(--warning);">Exit Game</button>
                </div>
            `;
            
            document.body.appendChild(gameContainer);
            
            // Spin the reels
            spinReels();
            
            // Exit button
            document.getElementById('exitFruitGame').addEventListener('click', hideFruitGame);
        }
        
function hideFruitGame() {
    const game = document.querySelector('.fruit-game-container');
    if (game) game.remove();
    fruitGameActive = false;
    
    // Stop any game sounds
    if (window.AudioContext) {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioCtx.close();
    }
    
    // Ensure translation popup is closed
    closeTranslationPopupHandler();
    
    setTimeout(() => {
        if (shouldAdvanceAfterGame) {
            const isLastPage = currentSentenceIndex >= sentences.length - 1;
            if (isLastPage) {
                // If we're on last page, loop back to first page
                currentSentenceIndex = 0;
            } else {
                // Otherwise just go to next page
                advanceToNextSentence();
            }
            shouldAdvanceAfterGame = false;
        }
        displayCurrentSentence(); // Always refresh display
    }, 500);
}
        
        function spinReels() {
            // Select a random category for this spin
            const currentCategory = categories[Math.floor(Math.random() * categories.length)];
            const items = currentCategory.items;
            
            const reels = [
                document.getElementById('reel1'),
                document.getElementById('reel2'),
                document.getElementById('reel3')
            ];
            const resultDisplay = document.getElementById('fruitResult');
            
            // Reset display
            resultDisplay.textContent = '';
            resultDisplay.style.color = '';
            
            // Play spinning sound
            playSound('spin');
            
            // Determine if we should have a match (1 in 3 chance)
            const shouldMatch = Math.random() < 0.33;
            let matchingItem = '';
            
            if (shouldMatch) {
                matchingItem = items[Math.floor(Math.random() * items.length)];
                // Update the matchingItem to be the full object (not just emoji)
                matchingItem = items.find(item => item.emoji === matchingItem.emoji) || matchingItem;
            }
            
            // Spin each reel with delays between them
            spinReel(reels[0], 0, items, matchingItem, shouldMatch, () => {
                playSound('reelStop');
                spinReel(reels[1], 300, items, matchingItem, shouldMatch, () => {
                    playSound('reelStop');
                    spinReel(reels[2], 300, items, matchingItem, shouldMatch, () => {
                        playSound('reelStop');
                        
                        // Check for win after last reel stops
                        setTimeout(() => {
                            if (shouldMatch && reels[0].textContent === reels[1].textContent && 
                                reels[1].textContent === reels[2].textContent) {
                                // Win condition
                                playSound('win');
                                playSound('coin');
                                resultDisplay.textContent = '🎉 WINNER! 🎉';
                                resultDisplay.style.color = 'var(--success)';
                                resultDisplay.style.fontWeight = 'bold';
                                
                                // Celebration animation
                                reels.forEach(reel => {
                                    reel.style.transform = 'scale(1.2)';
                                    reel.style.transition = 'all 0.3s';
                                    reel.style.boxShadow = '0 0 20px gold';
                                });
                                
                                // Confetti effect
                                setTimeout(() => {
                                    createConfetti();
                                }, 500);
                                
                                setTimeout(hideFruitGame, 3000);
                            } else {
                                // Lose condition
                                playSound('lose');
                                resultDisplay.textContent = 'Try again!';
                                resultDisplay.style.color = 'var(--warning)';
                                
                                // Shake animation
                                reels.forEach(reel => {
                                    reel.style.animation = 'shake 0.5s';
                                });
                                
                                setTimeout(hideFruitGame, 2000);
                            }
                        }, 300);
                    });
                });
            });
        }
        
        // Helper function to spin a single reel
        function spinReel(reel, delay, items, matchingItem, shouldMatch, callback) {
            const reelNumber = reel.id.replace('reel', '');
            const nameElement = document.getElementById(`name${reelNumber}`);
            
            setTimeout(() => {
                let spins = 0;
                const spinInterval = setInterval(() => {
                    // For the first few spins, show random items
                    if (spins < 10) {
                        const randomItem = items[Math.floor(Math.random() * items.length)];
                        reel.textContent = randomItem.emoji;
                        nameElement.textContent = '';
                    } 
                    // Then slow down to the final result
                    else if (spins < 15) {
                        if (spins % 2 === 0) {
                            const randomItem = items[Math.floor(Math.random() * items.length)];
                            reel.textContent = randomItem.emoji;
                            nameElement.textContent = '';
                        }
                    } 
                    // Final result
                    else {
                        clearInterval(spinInterval);
                        let finalItem;
                        if (shouldMatch) {
                            finalItem = matchingItem;
                        } else {
                            finalItem = items[Math.floor(Math.random() * items.length)];
                        }
                        reel.textContent = finalItem.emoji;
                        nameElement.textContent = finalItem.name;
                        
                        // Speak the name
                        if (window.speechSynthesis) {
                            const utterance = new SpeechSynthesisUtterance(finalItem.name);
                            utterance.rate = 0.9;
                            window.speechSynthesis.speak(utterance);
                        }
                        
                        if (callback) callback();
                    }
                    spins++;
                }, 100);
            }, delay);
        }
        
        // Confetti effect for wins
        function createConfetti() {
            const container = document.querySelector('.fruit-game-container');
            if (!container) return;
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.borderRadius = '50%';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = '-10px';
                confetti.style.opacity = '0.8';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.animation = `confetti-fall ${2 + Math.random() * 3}s linear forwards`;
                
                container.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }
        
        // Play sound effects
        function playSound(type) {
            if (!window.AudioContext) return;
            
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            let oscillator = audioCtx.createOscillator();
            let gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            // Different sounds for different events
            switch(type) {
                case 'spin':
                    // Continuous spinning sound
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.5);
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.8);
                    break;
                    
                case 'reelStop':
                    // Short click when a reel stops
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    break;
                    
                case 'win':
                    // Winning fanfare
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2); // G5
                    oscillator.frequency.setValueAtTime(1046.5, audioCtx.currentTime + 0.3); // C6
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.5);
                    break;
                    
                case 'lose':
                    // Sad trombone
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(349.23, audioCtx.currentTime); // F4
                    oscillator.frequency.exponentialRampToValueAtTime(261.63, audioCtx.currentTime + 0.5); // C4
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.6);
                    break;
                    
                case 'activate':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(784, audioCtx.currentTime); // G5
                    oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.2); // C6
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                    
                case 'coin':
                    // Coin sound for wins
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(988, audioCtx.currentTime); // B5
                    oscillator.frequency.exponentialRampToValueAtTime(1318, audioCtx.currentTime + 0.1); // E6
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.2);
                    break;
            }
        }

        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', function() {
            // Check for saved night mode preference
            const savedNightMode = localStorage.getItem('nightMode') === 'true';
            if (savedNightMode) {
                isNightMode = true;
                document.body.classList.add('dark-mode');
                nightModeToggle.textContent = '☀️';
            }
            
            init();
        });
    </script>
</body>
</html>
